<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>未取快递 - 快递取件码</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: linear-gradient(135deg, #F9F8FF 0%, #FAD0C4 50%, #D9C8FF 100%); background-attachment: fixed; color: #333333; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        header { background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.7); padding: 12px 16px; flex-shrink: 0; z-index: 180; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .header-title { font-size: 20px; font-weight: 600; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .edit-btn { padding: 8px 16px; border: none; background: rgba(102, 126, 234, 0.1); color: #667EEA; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; }
        .edit-btn.cancel { background: rgba(255, 107, 107, 0.1); color: #FF6B6B; }
        .tab-bar { display: flex; gap: 8px; padding: 0 12px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 12px 16px; border: none; background: rgba(255, 255, 255, 0.3); border-radius: 12px; color: #333333; font-size: 14px; cursor: pointer; min-height: 44px; }
        .tab-btn.active { background: rgba(102, 126, 234, 0.15); color: #667EEA; border: 1px solid rgba(102, 126, 234, 0.3); }
        .selection-info { display: none; text-align: right; padding: 0 12px; margin-bottom: 8px; font-size: 14px; color: #667EEA; }
        .selection-info.show { display: block; }
        main { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 0; }
        .date-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 0; }
        .date-group-header { background: transparent; border: none; border-radius: 0; padding: 0; display: flex; justify-content: flex-start; align-items: center; cursor: default; }
        .date-group-title { display: flex; align-items: center; gap: 0; flex: 1; flex-wrap: wrap; }
        .date-info, .count-info { display: none; }
        .date-info .material-icons, .count-info .material-icons { display: none; }
        .expand-icon { display: none; }
        .expand-icon.collapsed { display: none; }
        .date-group-items { display: flex; flex-direction: column; gap: 8px; max-height: 100000px; overflow: visible; transition: none; }
        .date-group-items.collapsed { max-height: 100000px; opacity: 1; }
        .location-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; margin-top: 8px; }
        .location-header.hidden { display: none; }
        .location-name { font-size: 15px; font-weight: 600; }
        .card { background: #FFFFFF; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06); padding: 16px; display: flex; gap: 12px; }
        .card.selected { border: 1px solid rgba(102, 126, 234, 0.3); }
        .card-checkbox { width: 20px; height: 20px; margin-top: 4px; cursor: pointer; accent-color: #667EEA; display: none; }
        .card-checkbox.show { display: block; }
        .card-content { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .card-code-box { display: flex; flex-direction: column; gap: 2px; flex: 1; }
        .card-code-label { font-size: 11px; color: #999999; text-transform: uppercase; font-weight: 400; letter-spacing: 0.5px; }
        .card-code { font-size: 16px; font-weight: 700; font-family: 'Courier New', monospace; letter-spacing: 1px; }
        .card-date-box { display: flex; flex-direction: column; gap: 1px; align-items: flex-end; padding: 4px 8px; background: rgba(102, 126, 234, 0.08); border-radius: 4px; min-width: auto; }
        .card-date-label { display: none; }
        .card-date { font-size: 12px; font-weight: 600; color: #667EEA; }
        .card-time { font-size: 10px; color: #AAAAAA; }
        .card-footer { display: flex; justify-content: flex-end; align-items: center; gap: 0; padding-top: 0; border-top: none; }
        .card-address { display: flex; align-items: flex-start; gap: 8px; flex: 1; }
        .card-address-icon { font-size: 16px; color: #667EEA; flex-shrink: 0; margin-top: 2px; }
        .card-address-text { font-size: 13px; color: #666666; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-clamp: 2; }
        .card-status { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; color: #FF9800; font-weight: 500; flex-shrink: 0; }
        .card-status .material-icons { font-size: 14px; }
        .floating-action-bar { position: fixed; bottom: 56px; left: 0; right: 0; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.7); display: flex; gap: 8px; padding: 12px; transform: translateY(100%); transition: transform 0.2s; z-index: 150; flex-wrap: wrap; }
        .floating-action-bar.show { transform: translateY(0); }
        .action-btn { flex: 1; min-width: 80px; padding: 12px 16px; border: none; background: rgba(102, 126, 234, 0.1); color: #667EEA; border-radius: 8px; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .action-btn .material-icons { font-size: 18px; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(0, 0, 0, 0.8); color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; z-index: 200; transition: transform 0.3s; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.7); display: flex; justify-content: space-around; height: 56px; z-index: 160; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; flex: 1; height: 100%; cursor: pointer; color: #999999; font-size: 12px; }
        .nav-item.active { color: #667EEA; }
        .nav-item .material-icons { font-size: 24px; }
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <h1 class="header-title">未取快递</h1>
            <div class="header-actions">
                <button class="edit-btn" id="editBtn" onclick="pickupAllPending()">一键取件</button>
                <span class="material-icons" style="cursor: pointer;">settings</span>
            </div>
        </div>
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('pending')">未取 (<span id="pendingCount">0</span>)</button>
            <button class="tab-btn" onclick="switchTab('picked')">已取 (<span id="pickedCount">0</span>)</button>
        </div>
        <div class="selection-info" id="selectionInfo">已选 <span id="selectedCount">0</span> 件</div>
    </header>

    <main id="mainContent"></main>

    <div class="floating-action-bar" id="floatingActionBar">
        <button class="action-btn" onclick="selectAll()"><span class="material-icons">done_all</span>全选</button>
        <button class="action-btn" onclick="clearSelection()"><span class="material-icons">clear</span>清空</button>
        <button class="action-btn" onclick="copySelectedCodes()"><span class="material-icons">content_copy</span>复制</button>
        <button class="action-btn" onclick="markAsPickedBatch()"><span class="material-icons">check_circle</span>已取</button>
    </div>

    <div class="toast" id="toast"></div>

    <div class="bottom-nav">
        <div class="nav-item active"><span class="material-icons">local_shipping</span><span>快递</span></div>
        <div class="nav-item"><span class="material-icons">label</span><span>标签</span></div>
        <div class="nav-item"><span class="material-icons">message</span><span>短信</span></div>
        <div class="nav-item"><span class="material-icons">settings</span><span>设置</span></div>
    </div>

    <script>
        let items = [
            { code: '2-4-2029', date: '2025-11-18', time: '10:35', address: '郑州市北文雅小区6号楼102取件', picked: false, selected: false },
            { code: '6-5-5011', date: '2025-11-18', time: '19:05', address: '郑州市北文雅小区6号楼102取件', picked: false, selected: false },
            { code: '5008', date: '2025-11-17', time: '14:22', address: '郑州市北文雅小区6号楼102取件', picked: false, selected: false },
            { code: '3028', date: '2025-10-28', time: '08:15', address: '郑州市北文雅小区6号楼102取件', picked: true, selected: false },
        ];

        let isEditMode = false;
        let lastAddress = null;

        window.addEventListener('DOMContentLoaded', () => {
            renderItems();
            updateCounts();
        });

        /**
         * 一键取件：取出所有未取快递，更新快递状态为已取
         */
        function pickupAllPending() {
            const pendingItems = items.filter(item => !item.picked);
            
            if (pendingItems.length === 0) {
                showToast('暂无未取快递');
                return;
            }
            
            // 显示确认对话框
            const count = pendingItems.length;
            const confirmed = confirm(`确定要一键取件 ${count} 个快递吗？`);
            
            if (!confirmed) {
                return;
            }
            
            // 将所有未取快递标记为已取
            pendingItems.forEach(item => {
                item.picked = true;
                item.selected = false;
            });
            
            // 更新 UI
            showToast(`已取件 ${count} 个快递`);
            renderItems();
            updateCounts();
            updateSelectedCount();
            updateFloatingBar();
        }

        function switchTab(tab) {
            if (tab === 'pending') {
                window.location.href = 'express_pickup_pending_uniform_spacing.html';
            } else if (tab === 'picked') {
                window.location.href = 'express_pickup_picked_optimized.html';
            }
        }

        function renderItems() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '';
            lastAddress = null;
            
            const pendingItems = items.filter(item => !item.picked);
            if (pendingItems.length === 0) {
                mainContent.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #8A8A8A;"><span class="material-icons" style="font-size: 48px; color: #CCCCCC; display: block; margin-bottom: 12px;">done_all</span><p>暂无未取快递</p></div>';
                return;
            }

            const grouped = {};
            pendingItems.forEach(item => {
                if (!grouped[item.date]) grouped[item.date] = [];
                grouped[item.date].push(item);
            });

            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            sortedDates.forEach(date => {
                const dateItems = grouped[date];
                const locationGrouped = {};
                dateItems.forEach(item => {
                    if (!locationGrouped[item.address]) locationGrouped[item.address] = [];
                    locationGrouped[item.address].push(item);
                });

                const dateGroup = document.createElement('div');
                dateGroup.className = 'date-group';
                dateGroup.innerHTML = `
                    <div class="date-group-header" data-date="${date}">
                        <div class="date-group-title">
                        </div>
                    </div>
                    <div class="date-group-items" data-date="${date}"></div>
                `;

                const itemsContainer = dateGroup.querySelector(`[data-date="${date}"].date-group-items`);
                Object.keys(locationGrouped).forEach(address => {
                    const locationItems = locationGrouped[address];
                    const locationHeader = document.createElement('div');
                    locationHeader.className = 'location-header';
                    
                    // 如果地址与上一个快递的地址相同，则隐藏地址标题
                    if (address === lastAddress) {
                        locationHeader.classList.add('hidden');
                    }
                    
                    locationHeader.innerHTML = `<div style="display: flex; align-items: center; gap: 8px;"><span class="material-icons" style="font-size: 18px; color: #667EEA;">location_on</span><span class="location-name">${address}</span></div>`;
                    itemsContainer.appendChild(locationHeader);
                    
                    locationItems.forEach(item => {
                        itemsContainer.appendChild(createCardElement(item));
                        lastAddress = item.address;
                    });
                });

                mainContent.appendChild(dateGroup);
            });
        }

        function createCardElement(item) {
            const card = document.createElement('div');
            card.className = `card ${item.selected ? 'selected' : ''}`;
            card.innerHTML = `
                <input type="checkbox" class="card-checkbox ${isEditMode ? 'show' : ''}" ${item.selected ? 'checked' : ''}>
                <div class="card-content">
                    <div class="card-header">
                        <div class="card-code-box">
                            <div class="card-code-label">取件码</div>
                            <div class="card-code">${item.code}</div>
                        </div>
                        <div class="card-date-box">
                            <div class="card-date-label">日期</div>
                            <div class="card-date">${item.date}</div>
                            <div class="card-time">${item.time}</div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="card-status">
                            <span class="material-icons">schedule</span><span>未取</span>
                        </div>
                    </div>
                </div>
            `;

            const checkbox = card.querySelector('.card-checkbox');
            checkbox.addEventListener('change', (e) => {
                item.selected = e.target.checked;
                card.classList.toggle('selected');
                updateSelectedCount();
                updateFloatingBar();
            });

            return card;
        }

        function updateCounts() {
            document.getElementById('pendingCount').textContent = items.filter(item => !item.picked).length;
            document.getElementById('pickedCount').textContent = items.filter(item => item.picked).length;
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = items.filter(item => item.selected).length;
        }

        function updateFloatingBar() {
            const selectedCount = items.filter(item => item.selected).length;
            const floatingBar = document.getElementById('floatingActionBar');
            if (isEditMode && selectedCount > 0) {
                floatingBar.classList.add('show');
            } else {
                floatingBar.classList.remove('show');
            }
        }

        function selectAll() {
            items.forEach(item => { if (!item.picked) item.selected = true; });
            renderItems();
            updateSelectedCount();
            updateFloatingBar();
        }

        function clearSelection() {
            items.forEach(item => item.selected = false);
            renderItems();
            updateSelectedCount();
            updateFloatingBar();
        }

        function copySelectedCodes() {
            const codes = items.filter(item => item.selected).map(item => item.code).join(', ');
            if (codes) {
                navigator.clipboard.writeText(codes).then(() => {
                    showToast(`已复制 ${items.filter(item => item.selected).length} 个取件码`);
                });
            }
        }

        function markAsPickedBatch() {
            const count = items.filter(item => item.selected).length;
            items.forEach(item => { if (item.selected) { item.picked = true; item.selected = false; } });
            showToast(`已标记 ${count} 个快递为已取`);
            renderItems();
            updateCounts();
            updateSelectedCount();
            updateFloatingBar();
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>
