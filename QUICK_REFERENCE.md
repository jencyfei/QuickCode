# 快速参考 - 规则管理和取件码提取

## 🚀 快速开始

### 访问规则管理页面
```
http://localhost:3000/rule-config
```

### 三个规则类型
1. **取件码** (pickup_code) - 提取快递取件码
2. **地址** (address) - 提取收货地址
3. **发件人** (sender) - 提取发件人信息

---

## 📋 当前内置规则（取件码）

| 优先级 | 规则名称 | 匹配示例 |
|--------|---------|--------|
| 10 | 标准取件码格式 | `取件码：ABC123` |
| 9 | 提货码格式 | `提货码：XYZ789` |
| **8** | **凭X-X-XXXX格式** | **`凭2-4-2029`** ✅ |
| 7 | 凭XX取件格式 | `凭ABC123` |
| 6 | 横杠分隔数字 | `2-4-2029` |
| 5 | 纯数字取件码 | `验证码：123456` |

---

## ✏️ 如何添加规则

### 步骤1：打开规则配置
访问 `http://localhost:3000/rule-config`

### 步骤2：选择规则类型
点击"取件码"、"地址"或"发件人"标签

### 步骤3：点击"添加规则"

### 步骤4：填写规则信息
```
规则名称：[描述性名称]
正则表达式：[正则表达式]
提取组：1（通常为1）
优先级：[数字，越大越优先]
描述：[规则说明]
启用：[勾选]
```

### 步骤5：测试规则
在"测试规则"区域输入测试文本，点击"测试"

### 步骤6：保存
点击"保存"按钮

---

## 🔍 常用正则表达式

### 取件码规则

#### 提取"凭XXXX"格式
```regex
凭\s*([A-Z0-9-]{3,12})
```

#### 提取"取件码：XXXX"格式
```regex
取件码[：:是为]?\s*([A-Z0-9-]{4,12})
```

#### 提取"X-X-XXXX"格式
```regex
(\d+-\d+-\d+)
```

#### 提取"XXXX"纯数字
```regex
(?:取件码|提货码)[：:是为]?\s*(\d{4,8})
```

### 地址规则

#### 提取驿站地址
```regex
([^\s，。！？]{2,20}?(?:驿站|快递柜|门卫)(?:[^\s，。！？]{0,10})?)
```

#### 提取小区地址
```regex
([^\s，。！？]{0,15}?(?:小区|大厦)(?:[^\s，。！？]{0,15}?(?:门口|大门|北门|南门|东门|西门))?)
```

### 发件人规则

#### 提取【】中的发件人
```regex
【(.+?)】
```

#### 提取[]中的发件人
```regex
\[(.+?)\]
```

---

## 🧪 测试规则

### 测试步骤
1. 在规则编辑页面，找到"测试规则"区域
2. 输入测试文本（完整的短信内容）
3. 点击"测试"按钮
4. 查看结果

### 测试示例

**测试文本**：
```
【菜鸟驿站】您的包裹已到站，凭2-4-2029到郑州市北文雅小区6号楼102店取件。
```

**规则**：
```
正则表达式：凭\s*(\d+-\d+-\d+)
提取组：1
```

**预期结果**：
```
✅ 匹配成功: 2-4-2029
```

---

## 🎯 优先级说明

- **优先级越高，规则越优先执行**
- 建议范围：0-100
- 常用优先级：
  - 10：最高优先级（最具体的规则）
  - 5-9：中等优先级
  - 0-4：低优先级（通用规则）

### 优先级设置建议

```
优先级10 ← 最具体的规则（如：标签格式）
优先级9  ← 特定格式规则
优先级8  ← 常见格式规则
优先级7  ← 通用格式规则
优先级6  ← 备选规则
优先级5  ← 最后尝试的规则
```

---

## 🔧 常见操作

### 修改规则优先级
1. 找到要修改的规则
2. 点击"编辑"
3. 修改"优先级"字段
4. 点击"保存"

### 禁用规则
1. 找到要禁用的规则
2. 点击规则右侧的开关按钮
3. 规则变为禁用状态

### 启用规则
1. 找到已禁用的规则
2. 点击规则右侧的开关按钮
3. 规则变为启用状态

### 删除规则
1. 找到要删除的规则
2. 点击"删除"按钮
3. 确认删除

---

## 📊 规则执行流程

```
短信内容
   ↓
按优先级排序所有启用的规则
   ↓
尝试优先级最高的规则
   ↓
匹配成功？ → 返回结果 ✅
   ↓
不匹配 → 尝试下一个规则
   ↓
所有规则都不匹配？ → 返回null ❌
```

---

## 💡 最佳实践

### ✅ 应该做

- ✅ 为具体的规则设置更高的优先级
- ✅ 在保存前测试规则
- ✅ 使用描述性的规则名称
- ✅ 定期审查和清理不需要的规则
- ✅ 为复杂的规则添加详细的描述

### ❌ 不应该做

- ❌ 使用过于宽泛的正则表达式
- ❌ 为所有规则设置相同的优先级
- ❌ 不测试就保存规则
- ❌ 删除内置规则（可以禁用）
- ❌ 使用过于复杂的正则表达式

---

## 🐛 故障排除

### 问题：规则不匹配

**解决方案**：
1. 使用测试功能验证正则表达式
2. 检查提取组编号是否正确
3. 确认规则已启用
4. 检查优先级是否过低

### 问题：提取结果不正确

**解决方案**：
1. 调整正则表达式
2. 修改提取组编号
3. 提高规则优先级
4. 禁用冲突的其他规则

### 问题：规则冲突

**解决方案**：
1. 为更具体的规则设置更高优先级
2. 禁用不需要的规则
3. 使用更精确的正则表达式

---

## 📚 相关文档

- [完整规则管理指南](./docs/RULE_MANAGEMENT_GUIDE.md)
- [内置规则优化说明](./docs/BUILTIN_RULES_OPTIMIZATION.md)
- [快递取件码修复指南](./docs/EXPRESS_DETAIL_GUIDE.md)

---

## 🔗 API 接口

### 获取规则
```bash
GET /extraction-rules?rule_type=pickup_code
```

### 创建规则
```bash
POST /extraction-rules
Content-Type: application/json

{
  "name": "规则名称",
  "rule_type": "pickup_code",
  "pattern": "正则表达式",
  "extract_group": 1,
  "priority": 8,
  "is_active": true,
  "description": "规则描述"
}
```

### 更新规则
```bash
PUT /extraction-rules/{rule_id}
Content-Type: application/json

{
  "priority": 9,
  "pattern": "新正则表达式"
}
```

### 删除规则
```bash
DELETE /extraction-rules/{rule_id}
```

### 测试规则
```bash
POST /extraction-rules/test
Content-Type: application/json

{
  "pattern": "正则表达式",
  "extract_group": 1,
  "test_text": "测试文本"
}
```

---

## 📞 支持

如有问题，请参考：
- [规则管理完整指南](./docs/RULE_MANAGEMENT_GUIDE.md)
- [内置规则优化说明](./docs/BUILTIN_RULES_OPTIMIZATION.md)
