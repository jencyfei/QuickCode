# DataViz Insights API设计文档

**文档版本**: 1.0  
**创建日期**: 2025年11月17日  
**目标**: 定义前后端交互接口

---

## 1. API基础信息

**Base URL**: `https://api.dataviz-insights.com/v1` (生产) / `http://localhost:8000/v1` (开发)

**认证方式**: JWT Token (Authorization: Bearer {token})

**响应格式**: JSON

**错误处理**: 统一错误响应格式

```json
{
  "code": 400,
  "message": "错误描述",
  "data": null,
  "timestamp": "2025-11-17T10:30:00Z"
}
```

---

## 2. 认证模块 API

### 2.1 用户注册

**请求**:
```
POST /auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "securePassword123",
  "name": "张三"
}
```

**响应** (201):
```json
{
  "code": 201,
  "message": "注册成功",
  "data": {
    "user_id": "uuid-xxx",
    "email": "user@example.com",
    "name": "张三",
    "created_at": "2025-11-17T10:30:00Z"
  }
}
```

### 2.2 用户登录

**请求**:
```
POST /auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "securePassword123"
}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "access_token": "eyJhbGc...",
    "token_type": "bearer",
    "expires_in": 86400,
    "user": {
      "user_id": "uuid-xxx",
      "email": "user@example.com",
      "name": "张三"
    }
  }
}
```

### 2.3 OAuth登录（Google/微信）

**请求**:
```
POST /auth/oauth
Content-Type: application/json

{
  "provider": "google",  // 或 "wechat"
  "code": "authorization_code_from_provider"
}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "access_token": "eyJhbGc...",
    "user": {
      "user_id": "uuid-xxx",
      "email": "user@example.com",
      "name": "张三"
    }
  }
}
```

---

## 3. 模板模块 API

### 3.1 获取模板列表

**请求**:
```
GET /templates?category=all&page=1&limit=10
Authorization: Bearer {token}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "templates": [
      {
        "template_id": "tpl-001",
        "name": "抖音电商",
        "category": "ecommerce",
        "description": "适用于抖音店铺销售分析",
        "icon": "https://...",
        "metrics": [
          {
            "name": "GMV",
            "formula": "SUM(sales_amount)",
            "description": "总销售额"
          },
          {
            "name": "转化率",
            "formula": "COUNT(order_id) / COUNT(visitor_id)",
            "description": "访客转化率"
          }
        ],
        "chart_type": "line",
        "created_at": "2025-11-01T00:00:00Z"
      }
    ],
    "total": 12,
    "page": 1,
    "limit": 10
  }
}
```

### 3.2 获取模板详情

**请求**:
```
GET /templates/{template_id}
Authorization: Bearer {token}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "template_id": "tpl-001",
    "name": "抖音电商",
    "category": "ecommerce",
    "description": "适用于抖音店铺销售分析",
    "metrics": [
      {
        "name": "GMV",
        "formula": "SUM(sales_amount)",
        "type": "number"
      },
      {
        "name": "转化率",
        "formula": "COUNT(order_id) / COUNT(visitor_id)",
        "type": "percentage"
      }
    ],
    "chart_recommendations": [
      {
        "type": "line",
        "title": "销售趋势",
        "x_axis": "date",
        "y_axis": "GMV"
      }
    ]
  }
}
```

---

## 4. 数据处理模块 API

### 4.1 上传数据文件

**请求**:
```
POST /data/upload
Authorization: Bearer {token}
Content-Type: multipart/form-data

{
  "file": <CSV/JSON文件>,
  "analysis_name": "我的销售分析",
  "template_id": "tpl-001" (可选)
}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "upload_id": "upload-xxx",
    "file_name": "sales_data.csv",
    "file_size": 2500,
    "rows": 1000,
    "columns": [
      {
        "name": "order_id",
        "type": "integer",
        "sample_values": [1, 2, 3]
      },
      {
        "name": "sales_amount",
        "type": "float",
        "sample_values": [99.99, 199.99]
      },
      {
        "name": "date",
        "type": "date",
        "sample_values": ["2025-11-01", "2025-11-02"]
      }
    ]
  }
}
```

### 4.2 获取数据预览

**请求**:
```
GET /data/{upload_id}/preview?rows=5
Authorization: Bearer {token}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "columns": ["order_id", "sales_amount", "date", "category"],
    "rows": [
      [1, 99.99, "2025-11-01", "electronics"],
      [2, 199.99, "2025-11-02", "clothing"],
      [3, 49.99, "2025-11-03", "books"]
    ]
  }
}
```

---

## 5. 分析模块 API

### 5.1 创建分析

**请求**:
```
POST /analysis
Authorization: Bearer {token}
Content-Type: application/json

{
  "analysis_name": "我的销售分析",
  "upload_id": "upload-xxx",
  "metrics": [
    {
      "name": "总销售额",
      "formula": "SUM(sales_amount)"
    },
    {
      "name": "订单数",
      "formula": "COUNT(order_id)"
    },
    {
      "name": "客单价",
      "formula": "SUM(sales_amount) / COUNT(order_id)"
    }
  ],
  "chart_configs": [
    {
      "type": "line",
      "title": "销售趋势",
      "x_axis": "date",
      "y_axis": "总销售额",
      "metrics": ["总销售额"]
    }
  ]
}
```

**响应** (201):
```json
{
  "code": 201,
  "message": "分析创建成功",
  "data": {
    "analysis_id": "analysis-xxx",
    "analysis_name": "我的销售分析",
    "status": "processing",
    "created_at": "2025-11-17T10:30:00Z"
  }
}
```

### 5.2 获取分析结果

**请求**:
```
GET /analysis/{analysis_id}
Authorization: Bearer {token}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "analysis_id": "analysis-xxx",
    "analysis_name": "我的销售分析",
    "status": "completed",
    "metrics": [
      {
        "name": "总销售额",
        "value": 125000,
        "unit": "¥",
        "trend": "+15%"
      },
      {
        "name": "订单数",
        "value": 500,
        "unit": "个",
        "trend": "+10%"
      }
    ],
    "charts": [
      {
        "chart_id": "chart-001",
        "type": "line",
        "title": "销售趋势",
        "data": {
          "labels": ["2025-11-01", "2025-11-02", ...],
          "datasets": [
            {
              "label": "总销售额",
              "data": [5000, 6000, 7000, ...],
              "borderColor": "#6366F1"
            }
          ]
        }
      }
    ],
    "insights": {
      "summary": "销售呈上升趋势，近7天增长15%。",
      "anomalies": [
        {
          "date": "2025-11-15",
          "description": "销售下降30%，建议检查营销活动。"
        }
      ],
      "recommendations": [
        "优化内容质量，提升完成率",
        "增加投放预算，扩大流量",
        "A/B测试新文案，优化转化率"
      ]
    }
  }
}
```

### 5.3 获取分析列表

**请求**:
```
GET /analysis?page=1&limit=10&sort=-created_at
Authorization: Bearer {token}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "analyses": [
      {
        "analysis_id": "analysis-001",
        "analysis_name": "抖音销售分析",
        "status": "completed",
        "created_at": "2025-11-16T10:30:00Z",
        "updated_at": "2025-11-16T10:35:00Z",
        "metrics_count": 5,
        "charts_count": 3
      }
    ],
    "total": 12,
    "page": 1,
    "limit": 10
  }
}
```

### 5.4 删除分析

**请求**:
```
DELETE /analysis/{analysis_id}
Authorization: Bearer {token}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

---

## 6. AI建议模块 API

### 6.1 获取指标建议

**请求**:
```
POST /ai/suggest-metrics
Authorization: Bearer {token}
Content-Type: application/json

{
  "upload_id": "upload-xxx",
  "description": "我想分析抖音店铺的销售数据"
}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "建议生成成功",
  "data": {
    "detected_type": "ecommerce",
    "suggested_metrics": [
      {
        "name": "GMV",
        "formula": "SUM(sales_amount)",
        "description": "总销售额",
        "confidence": 0.95
      },
      {
        "name": "转化率",
        "formula": "COUNT(order_id) / COUNT(visitor_id)",
        "description": "访客转化率",
        "confidence": 0.90
      }
    ]
  }
}
```

### 6.2 获取图表推荐

**请求**:
```
POST /ai/recommend-charts
Authorization: Bearer {token}
Content-Type: application/json

{
  "analysis_id": "analysis-xxx",
  "metrics": ["总销售额", "订单数", "客单价"]
}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "推荐生成成功",
  "data": {
    "recommendations": [
      {
        "type": "line",
        "title": "销售趋势",
        "description": "展示销售额随时间的变化趋势",
        "x_axis": "date",
        "y_axis": "总销售额",
        "confidence": 0.95
      },
      {
        "type": "bar",
        "title": "分类销售对比",
        "description": "展示不同分类的销售额对比",
        "x_axis": "category",
        "y_axis": "总销售额",
        "confidence": 0.85
      }
    ]
  }
}
```

---

## 7. 导出分享模块 API

### 7.1 导出分析

**请求**:
```
POST /export/analysis/{analysis_id}
Authorization: Bearer {token}
Content-Type: application/json

{
  "format": "pdf",  // pdf, png, csv
  "include": ["charts", "insights", "metrics"]
}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "导出成功",
  "data": {
    "download_url": "https://...",
    "file_name": "analysis_20251117.pdf",
    "file_size": 2500000,
    "expires_in": 3600
  }
}
```

### 7.2 生成分享链接

**请求**:
```
POST /share/analysis/{analysis_id}
Authorization: Bearer {token}
Content-Type: application/json

{
  "password": "optional_password",
  "expires_in": 604800  // 7天（秒）
}
```

**响应** (201):
```json
{
  "code": 201,
  "message": "分享链接生成成功",
  "data": {
    "share_id": "share-xxx",
    "share_url": "https://dataviz-insights.com/share/share-xxx",
    "password_protected": true,
    "expires_at": "2025-11-24T10:30:00Z"
  }
}
```

### 7.3 访问分享链接

**请求**:
```
GET /share/{share_id}?password=optional_password
```

**响应** (200):
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "analysis": {
      "analysis_name": "我的销售分析",
      "metrics": [...],
      "charts": [...],
      "insights": {...}
    }
  }
}
```

---

## 8. 用户设置模块 API

### 8.1 获取用户信息

**请求**:
```
GET /user/profile
Authorization: Bearer {token}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "user_id": "uuid-xxx",
    "email": "user@example.com",
    "name": "张三",
    "avatar": "https://...",
    "subscription_plan": "basic",  // free, basic, premium
    "subscription_expires_at": "2025-12-17T00:00:00Z",
    "created_at": "2025-11-01T00:00:00Z"
  }
}
```

### 8.2 更新用户信息

**请求**:
```
PUT /user/profile
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "张三",
  "avatar": "https://..."
}
```

**响应** (200):
```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "user_id": "uuid-xxx",
    "name": "张三",
    "avatar": "https://..."
  }
}
```

---

## 9. 订阅模块 API

### 9.1 获取订阅计划

**请求**:
```
GET /subscription/plans
```

**响应** (200):
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "plans": [
      {
        "plan_id": "free",
        "name": "免费版",
        "price": 0,
        "features": [
          "5个分析/月",
          "基础模板库"
        ]
      },
      {
        "plan_id": "basic",
        "name": "基本版",
        "price": 9,
        "currency": "USD",
        "features": [
          "无限分析",
          "完整模板库",
          "导出功能"
        ]
      },
      {
        "plan_id": "premium",
        "name": "高级版",
        "price": 19,
        "currency": "USD",
        "features": [
          "无限分析",
          "AI深度insights",
          "批量处理",
          "导出功能",
          "移动推送"
        ]
      }
    ]
  }
}
```

### 9.2 创建订阅

**请求**:
```
POST /subscription/create
Authorization: Bearer {token}
Content-Type: application/json

{
  "plan_id": "basic",
  "payment_method": "stripe_token"
}
```

**响应** (201):
```json
{
  "code": 201,
  "message": "订阅成功",
  "data": {
    "subscription_id": "sub-xxx",
    "plan_id": "basic",
    "status": "active",
    "current_period_start": "2025-11-17T00:00:00Z",
    "current_period_end": "2025-12-17T00:00:00Z"
  }
}
```

---

## 10. 错误码参考

| 错误码 | 描述 | HTTP状态码 |
|--------|------|-----------|
| 400 | 请求参数错误 | 400 |
| 401 | 未授权（Token过期或无效） | 401 |
| 403 | 禁止访问（权限不足） | 403 |
| 404 | 资源不存在 | 404 |
| 409 | 冲突（如邮箱已存在） | 409 |
| 422 | 数据验证失败 | 422 |
| 429 | 请求过于频繁 | 429 |
| 500 | 服务器错误 | 500 |
| 503 | 服务不可用 | 503 |

---

## 11. 速率限制

- **认证端点**: 10请求/分钟
- **数据上传**: 100MB/小时
- **API调用**: 1000请求/小时（免费版）、10000请求/小时（付费版）

---

## 12. 下一步

- [ ] 在Swagger UI中实现API文档
- [ ] 编写API集成测试
- [ ] 准备API Mock服务（前端开发用）
