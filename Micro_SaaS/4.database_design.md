# DataViz Insights 数据库设计文档

**文档版本**: 1.0  
**创建日期**: 2025年11月17日  
**数据库**: PostgreSQL 14+

---

## 1. 数据库概览

### 1.1 核心表结构

```
users (用户表)
├── user_id (PK)
├── email (UNIQUE)
├── password_hash
├── name
├── avatar
├── subscription_plan
├── created_at
└── updated_at

templates (模板表)
├── template_id (PK)
├── name
├── category
├── description
├── metrics (JSON)
├── chart_recommendations (JSON)
└── created_at

uploads (数据上传表)
├── upload_id (PK)
├── user_id (FK)
├── file_name
├── file_path
├── file_size
├── rows_count
├── columns (JSON)
├── created_at
└── updated_at

analyses (分析表)
├── analysis_id (PK)
├── user_id (FK)
├── upload_id (FK)
├── template_id (FK, nullable)
├── analysis_name
├── metrics (JSON)
├── chart_configs (JSON)
├── status (processing/completed/failed)
├── created_at
└── updated_at

analysis_results (分析结果表)
├── result_id (PK)
├── analysis_id (FK)
├── metrics_data (JSON)
├── charts_data (JSON)
├── insights (JSON)
└── created_at

shares (分享表)
├── share_id (PK)
├── analysis_id (FK)
├── user_id (FK)
├── password_hash (nullable)
├── expires_at
├── created_at
└── updated_at

subscriptions (订阅表)
├── subscription_id (PK)
├── user_id (FK)
├── plan_id
├── status (active/cancelled/expired)
├── current_period_start
├── current_period_end
├── created_at
└── updated_at
```

---

## 2. 详细表设计

### 2.1 users 表

```sql
CREATE TABLE users (
  user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(100) NOT NULL,
  avatar VARCHAR(500),
  subscription_plan VARCHAR(50) DEFAULT 'free',  -- free, basic, premium
  oauth_provider VARCHAR(50),  -- google, wechat, null
  oauth_id VARCHAR(255),
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$')
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_subscription_plan ON users(subscription_plan);
```

### 2.2 templates 表

```sql
CREATE TABLE templates (
  template_id VARCHAR(50) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  category VARCHAR(50) NOT NULL,  -- ecommerce, delivery, social, finance, general
  description TEXT,
  icon_url VARCHAR(500),
  metrics JSONB NOT NULL,  -- 存储指标定义
  chart_recommendations JSONB,  -- 存储图表推荐
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_templates_category ON templates(category);
CREATE INDEX idx_templates_is_active ON templates(is_active);

-- 示例数据
INSERT INTO templates VALUES (
  'tpl-001',
  '抖音电商',
  'ecommerce',
  '适用于抖音店铺销售分析',
  'https://...',
  '[
    {"name": "GMV", "formula": "SUM(sales_amount)", "type": "number"},
    {"name": "转化率", "formula": "COUNT(order_id) / COUNT(visitor_id)", "type": "percentage"}
  ]'::jsonb,
  '[
    {"type": "line", "title": "销售趋势", "x_axis": "date", "y_axis": "GMV"}
  ]'::jsonb,
  TRUE,
  CURRENT_TIMESTAMP,
  CURRENT_TIMESTAMP
);
```

### 2.3 uploads 表

```sql
CREATE TABLE uploads (
  upload_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  file_name VARCHAR(255) NOT NULL,
  file_path VARCHAR(500) NOT NULL,
  file_size BIGINT NOT NULL,  -- 字节
  rows_count INTEGER,
  columns JSONB NOT NULL,  -- 存储列信息
  file_hash VARCHAR(64),  -- SHA256哈希，用于去重
  storage_type VARCHAR(50) DEFAULT 's3',  -- s3, local
  is_deleted BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT file_size_limit CHECK (file_size <= 104857600)  -- 100MB
);

CREATE INDEX idx_uploads_user_id ON uploads(user_id);
CREATE INDEX idx_uploads_created_at ON uploads(created_at);
CREATE INDEX idx_uploads_file_hash ON uploads(file_hash);
```

### 2.4 analyses 表

```sql
CREATE TABLE analyses (
  analysis_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  upload_id UUID NOT NULL REFERENCES uploads(upload_id) ON DELETE CASCADE,
  template_id VARCHAR(50) REFERENCES templates(template_id),
  analysis_name VARCHAR(255) NOT NULL,
  metrics JSONB NOT NULL,  -- 用户定义的指标
  chart_configs JSONB,  -- 图表配置
  status VARCHAR(50) DEFAULT 'processing',  -- processing, completed, failed
  error_message TEXT,
  processing_time_ms INTEGER,  -- 处理耗时
  is_deleted BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_analyses_user_id ON analyses(user_id);
CREATE INDEX idx_analyses_status ON analyses(status);
CREATE INDEX idx_analyses_created_at ON analyses(created_at DESC);
CREATE INDEX idx_analyses_is_deleted ON analyses(is_deleted);
```

### 2.5 analysis_results 表

```sql
CREATE TABLE analysis_results (
  result_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  analysis_id UUID NOT NULL UNIQUE REFERENCES analyses(analysis_id) ON DELETE CASCADE,
  metrics_data JSONB NOT NULL,  -- 计算结果
  charts_data JSONB NOT NULL,  -- 图表数据
  insights JSONB,  -- AI生成的insights
  data_summary JSONB,  -- 数据摘要
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_analysis_results_analysis_id ON analysis_results(analysis_id);
```

### 2.6 shares 表

```sql
CREATE TABLE shares (
  share_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  analysis_id UUID NOT NULL REFERENCES analyses(analysis_id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  password_hash VARCHAR(255),  -- 可选的分享密码
  access_count INTEGER DEFAULT 0,
  expires_at TIMESTAMP,
  is_expired BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_shares_share_id ON shares(share_id);
CREATE INDEX idx_shares_analysis_id ON shares(analysis_id);
CREATE INDEX idx_shares_user_id ON shares(user_id);
CREATE INDEX idx_shares_expires_at ON shares(expires_at);
```

### 2.7 subscriptions 表

```sql
CREATE TABLE subscriptions (
  subscription_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL UNIQUE REFERENCES users(user_id) ON DELETE CASCADE,
  plan_id VARCHAR(50) NOT NULL,  -- free, basic, premium
  status VARCHAR(50) DEFAULT 'active',  -- active, cancelled, expired
  stripe_subscription_id VARCHAR(255),
  current_period_start TIMESTAMP NOT NULL,
  current_period_end TIMESTAMP NOT NULL,
  cancel_at_period_end BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
CREATE INDEX idx_subscriptions_current_period_end ON subscriptions(current_period_end);
```

### 2.8 audit_logs 表（审计日志）

```sql
CREATE TABLE audit_logs (
  log_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(user_id) ON DELETE SET NULL,
  action VARCHAR(100) NOT NULL,  -- upload, analyze, export, share
  resource_type VARCHAR(50),  -- analysis, upload, template
  resource_id UUID,
  details JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
```

---

## 3. 关键查询优化

### 3.1 获取用户最近的分析

```sql
SELECT 
  a.analysis_id,
  a.analysis_name,
  a.status,
  a.created_at,
  COUNT(DISTINCT c.chart_id) as chart_count
FROM analyses a
LEFT JOIN analysis_results ar ON a.analysis_id = ar.analysis_id
WHERE a.user_id = $1 AND a.is_deleted = FALSE
ORDER BY a.created_at DESC
LIMIT 10;
```

### 3.2 获取用户的订阅状态

```sql
SELECT 
  u.user_id,
  u.subscription_plan,
  s.plan_id,
  s.status,
  s.current_period_end
FROM users u
LEFT JOIN subscriptions s ON u.user_id = s.user_id
WHERE u.user_id = $1;
```

### 3.3 统计用户的分析数量（用于限流）

```sql
SELECT 
  COUNT(*) as analysis_count,
  DATE(a.created_at) as date
FROM analyses a
WHERE a.user_id = $1 
  AND a.created_at >= CURRENT_DATE - INTERVAL '30 days'
  AND a.is_deleted = FALSE
GROUP BY DATE(a.created_at)
ORDER BY date DESC;
```

---

## 4. 数据库初始化脚本

### 4.1 创建所有表

```bash
# 使用psql连接数据库
psql -U postgres -d dataviz_insights -f schema.sql
```

### 4.2 schema.sql 文件内容

```sql
-- 创建扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- 创建所有表（见上面的详细表设计）

-- 创建视图：用户统计
CREATE VIEW user_statistics AS
SELECT 
  u.user_id,
  u.email,
  u.subscription_plan,
  COUNT(DISTINCT a.analysis_id) as total_analyses,
  COUNT(DISTINCT CASE WHEN a.created_at >= CURRENT_DATE - INTERVAL '30 days' THEN a.analysis_id END) as analyses_last_30_days,
  MAX(a.created_at) as last_analysis_date
FROM users u
LEFT JOIN analyses a ON u.user_id = a.user_id AND a.is_deleted = FALSE
GROUP BY u.user_id;

-- 创建视图：分析详情
CREATE VIEW analysis_details AS
SELECT 
  a.analysis_id,
  a.user_id,
  a.analysis_name,
  a.status,
  u.name as user_name,
  u.email,
  COUNT(DISTINCT s.share_id) as share_count,
  a.created_at,
  a.updated_at
FROM analyses a
JOIN users u ON a.user_id = u.user_id
LEFT JOIN shares s ON a.analysis_id = s.analysis_id
WHERE a.is_deleted = FALSE
GROUP BY a.analysis_id, u.user_id;
```

---

## 5. 备份与恢复

### 5.1 备份数据库

```bash
# 完整备份
pg_dump -U postgres dataviz_insights > backup_$(date +%Y%m%d_%H%M%S).sql

# 压缩备份
pg_dump -U postgres dataviz_insights | gzip > backup_$(date +%Y%m%d_%H%M%S).sql.gz
```

### 5.2 恢复数据库

```bash
# 从备份恢复
psql -U postgres dataviz_insights < backup_20251117_100000.sql

# 从压缩备份恢复
gunzip -c backup_20251117_100000.sql.gz | psql -U postgres dataviz_insights
```

---

## 6. 性能优化建议

### 6.1 索引策略

- **热查询索引**: user_id, created_at, status
- **复合索引**: (user_id, created_at DESC) 用于分页查询
- **JSONB索引**: 对频繁查询的JSON字段使用GIN索引

```sql
CREATE INDEX idx_analyses_user_created ON analyses(user_id, created_at DESC);
CREATE INDEX idx_metrics_data_gin ON analysis_results USING GIN(metrics_data);
```

### 6.2 分区策略

对于大型表（如audit_logs），使用时间分区：

```sql
CREATE TABLE audit_logs_2025_11 PARTITION OF audit_logs
  FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');
```

### 6.3 缓存策略

- Redis缓存热数据（用户订阅状态、模板列表）
- 缓存TTL: 1小时

---

## 7. 安全考虑

### 7.1 数据加密

- 密码: bcrypt + salt
- 敏感数据: AES-256加密
- 传输: HTTPS + TLS 1.3

### 7.2 访问控制

- 行级安全 (RLS): 用户只能访问自己的数据
- 角色权限: 区分管理员、普通用户

```sql
-- 启用RLS
ALTER TABLE analyses ENABLE ROW LEVEL SECURITY;

-- 创建策略
CREATE POLICY user_analyses_policy ON analyses
  FOR SELECT USING (user_id = current_user_id());
```

---

## 8. 监控与维护

### 8.1 定期维护任务

```sql
-- 清理过期分享链接
DELETE FROM shares WHERE expires_at < CURRENT_TIMESTAMP;

-- 清理已删除的分析（保留30天）
DELETE FROM analyses 
WHERE is_deleted = TRUE AND updated_at < CURRENT_TIMESTAMP - INTERVAL '30 days';

-- 更新表统计信息
ANALYZE;
```

### 8.2 性能监控

```sql
-- 查看慢查询
SELECT query, calls, mean_time FROM pg_stat_statements 
WHERE mean_time > 1000 
ORDER BY mean_time DESC;

-- 查看表大小
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

---

## 9. 迁移策略

### 9.1 初始化迁移

```bash
# 使用Alembic进行数据库迁移
alembic init alembic
alembic revision --autogenerate -m "Initial migration"
alembic upgrade head
```

### 9.2 版本升级迁移

```bash
# 添加新字段
alembic revision --autogenerate -m "Add new_column to users"
alembic upgrade head
```

---

## 10. 下一步

- [ ] 在PostgreSQL中创建所有表
- [ ] 配置备份策略
- [ ] 设置监控告警
- [ ] 编写数据库文档
