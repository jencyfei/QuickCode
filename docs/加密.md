# 短信管理APP付费买断制开发文档

## 文档概述
本文档针对现有短信管理APP（功能包括快递取件码提取、短信打标和批量处理）添加付费买断制功能。采用推荐的组合方案：**机器码绑定 + 有限激活码**。此方案保持APP纯本地运行、无需联网，确保隐私安全，同时有效防止二次售卖（用户购买激活码后，码仅限特定设备和有限激活次数使用）。

- **买断价格**：12元/码（一次性付费）。
- **核心目标**：用户购买激活码后，输入码激活APP高级功能（如无限批量处理）。码绑定设备唯一ID，激活次数限1-5次（可配置），防止分享或多次安装。
- **适用平台**：假设APP基于Python（跨平台，如PyQt桌面版）或Android（Java/Kotlin）。文档以Python示例为主，便于扩展。
- **开发原则**：本地加密存储激活状态，无云端验证。使用哈希或加密库防篡改。
- **版本**：适用于当前APP v1.0+，更新日期：2025年11月24日。
- **开发者**： [您的姓名或公司名]

## 需求与前提
### 功能需求
- **激活流程**：首次运行或到期弹窗后，弹出激活输入框。用户输入12元购买的激活码，验证后解锁功能。
- **机器码绑定**：生成设备唯一ID（e.g., CPU/硬盘序列号或Android ID），激活码包含此ID的加密版本。不同设备需新码。
- **有限激活次数**：每个码默认限3次激活（防用户备份/重装）。本地加密计数器，超限失效。
- **到期弹窗集成**：2026年1月后弹窗提示“购买激活码继续使用高级功能”，点击取消继续基本功能，但高级功能（如批量处理）锁定。
- **防二次售卖**：码唯一，分享后新设备不匹配；次数用尽无效。
- **用户体验**：激活后，本地存储状态，重启无需重复输入。

### 技术前提
- **库依赖**：Python中使用`uuid`（设备ID）、`hashlib`（哈希加密）、`cryptography`（可选高级加密）。Android中使用`Settings.Secure.ANDROID_ID`。
- **存储**：本地文件或数据库（e.g., SQLite）加密保存激活数据。
- **测试环境**：多设备测试（虚拟机/不同手机）。
- **法律合规**：声明中说明“一码一机”，并处理退款（如码失效）。

## 实现步骤
### 步骤1: 生成设备唯一ID
- 目的：绑定激活码到具体设备。
- Python实现：使用`uuid`或系统命令获取硬件ID。
- 示例代码：
  ```python
  import uuid
  import hashlib

  def get_device_id():
      # 获取机器唯一ID（可结合MAC地址或CPU ID）
      node = uuid.getnode()  # MAC地址为基础
      return hashlib.sha256(str(node).encode()).hexdigest()  # 哈希加密
  ```

- Android示例（Kotlin）：
  ```kotlin
  import android.provider.Settings
  fun getDeviceId(context: Context): String {
      val androidId = Settings.Secure.getString(context.contentResolver, Settings.Secure.ANDROID_ID)
      return MessageDigest.getInstance("SHA-256").digest(androidId.toByteArray()).joinToString("") { "%02x".format(it) }
  }
  ```

### 步骤2: 激活码生成与分发
- 开发者侧：用户支付12元后，你手动/自动化生成激活码。
- 码格式：设备ID + 随机盐 + 激活次数 的加密字符串（e.g., Base64编码）。
- 示例生成脚本（开发者用，非APP内）：
  ```python
  from cryptography.fernet import Fernet
  import base64
  import secrets

  # 生成密钥（开发者私钥，保密）
  key = Fernet.generate_key()  # 只生成一次，保存

  def generate_activation_code(device_id, max_activations=3):
      salt = secrets.token_hex(8)  # 随机盐
      data = f"{device_id}:{max_activations}:{salt}"
      cipher = Fernet(key)
      encrypted = cipher.encrypt(data.encode())
      return base64.urlsafe_b64encode(encrypted).decode()
  ```
- 分发：通过邮箱或微信发码给用户。用户提供设备ID（APP显示）后生成。

### 步骤3: APP内激活验证逻辑
- 集成到设置页面或弹窗。
- 验证流程：解密码，检查设备ID匹配、激活次数>0，然后递减计数并保存。
- 示例Python代码（APP主逻辑）：
  ```python
  from cryptography.fernet import Fernet, InvalidToken
  import os
  import json

  # 开发者公钥（APP内置）
  KEY = b'你的密钥base64'  # 从开发者侧复制

  ACTIVATION_FILE = 'activation.json'  # 本地加密文件

  def validate_activation(code):
      device_id = get_device_id()
      try:
          cipher = Fernet(KEY)
          decrypted = cipher.decrypt(base64.urlsafe_b64decode(code)).decode()
          parts = decrypted.split(':')
          if len(parts) != 3 or parts[0] != device_id:
              return False, "设备不匹配"
          remaining = int(parts[1])
          if remaining <= 0:
              return False, "激活次数已用尽"
          # 激活成功，递减并保存
          new_data = {
              'code': code,
              'remaining': remaining - 1,
              'device_id': device_id
          }
          with open(ACTIVATION_FILE, 'w') as f:
              json.dump(new_data, f)  # 可进一步加密文件
          return True, "激活成功"
      except InvalidToken:
          return False, "无效激活码"

  def is_activated():
      if os.path.exists(ACTIVATION_FILE):
          with open(ACTIVATION_FILE, 'r') as f:
              data = json.load(f)
          if data['device_id'] == get_device_id() and data['remaining'] >= 0:
              return True
      return False  # 未激活，锁定高级功能
  ```

- 集成到期弹窗：
  ```python
  import datetime

  def check_expiry():
      expiry_date = datetime.date(2026, 1, 1)
      if datetime.date.today() > expiry_date and not is_activated():
          # 显示弹窗："到期了，输入激活码解锁"，点击取消继续基本功能
          pass  # GUI代码，如Tkinter弹出
  ```

### 步骤4: 锁定高级功能
- 在APP代码中，检查`is_activated()`：
  - 如果未激活：禁用批量处理、限制标签数量。
  - 示例：
    ```python
    def bulk_process(tag):
        if not is_activated():
            raise Exception("请激活买断版")
        # 执行批量处理逻辑
    ```

### 步骤5: 更新软件声明与反馈
- 在设置页面添加：
  - “本APP买断制：12元/码，一码一机，限3次激活。”
  - 集成之前写的软件声明和反馈说明（邮箱：709662224@qq.com）。

## 测试指南
- **单元测试**：测试生成/验证码，模拟不同设备ID。
- **端到端测试**：安装APP，输入码激活；复制文件到新设备，验证失效；重装APP，检查次数递减。
- **边缘案例**：无效码、超期弹窗、文件篡改（添加校验和防 tamper）。
- **工具**：使用pytest（Python）或JUnit（Android）自动化。

## 注意事项与风险
- **安全**：密钥保密，防止逆向工程（用obfuscator工具混淆代码）。
- **用户支持**：处理“换设备”请求（手动发新码，收费或免费）。
- **更新**：未来版本兼容旧激活码。
- **潜在问题**：高手可破解（e.g., 修改文件），但对大众用户有效。监控反馈，迭代。

