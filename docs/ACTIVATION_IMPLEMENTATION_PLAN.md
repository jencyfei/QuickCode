# 付费买断制实现阶段规划（严格对齐《加密.md》）

## 阶段1：对齐加密协议（Fernet + Python 生成脚本）

### 1.1 密钥管理方案（开发者侧）

- **目标**：确定 Fernet 密钥的生成、保存和备份方式。
- **任务**：
  - [ ] 在本机生成一次性 Fernet 密钥（`Fernet.generate_key()`）。
  - [ ] 将密钥安全保存（例如 `.env` 或本地配置文件，不入 Git 仓库）。
  - [ ] 约定密钥的备份与恢复流程（避免丢失后旧激活码全部失效）。

### 1.2 Python 激活码生成脚本 `tools/generate_activation_code.py`

- **目标**：完全实现《加密.md》中“步骤2：激活码生成与分发”的逻辑。
- **任务**：
  - [ ] 读取本地保存的 Fernet 密钥。
  - [ ] 提供命令行接口：
    - 参数：`--device-id`、`--max-activations`（默认 3）、`--count`（可选，批量生成）。
  - [ ] 使用随机盐（`secrets.token_hex(8)`）构造明文：`"{device_id}:{max_activations}:{salt}"`。
  - [ ] 使用 `Fernet` 加密明文，得到密文。
  - [ ] 使用 `base64.urlsafe_b64encode` 再编码为最终激活码字符串。
  - [ ] 在终端打印激活码，并可选写入 `activation_codes.csv`（包含 device_id / 剩余次数 / 激活码）。

### 1.3 文档固化 Python 生成流程

- **目标**：确保后续运维/发码时有清晰指南。
- **任务**：
  - [ ] 在 `docs/ACTIVATION_DEVELOPER_GUIDE.md` 中记录：
    - 如何生成/管理 Fernet 密钥。
    - 如何从用户提供的设备 ID 生成激活码。
    - 示例命令和输出格式。

---

## 阶段2：Android 端对齐 Fernet 解密协议

### 2.1 接入 Fernet 兼容解码逻辑

- **目标**：`ActivationManager.decodeActivationCode` 严格匹配 Python 生成的格式。
- **任务**：
  - [ ] 选定 Fernet 兼容实现方案（移植 Fernet 算法，或约定等价的 AES 模式）。
  - [ ] 将开发者密钥以**安全方式内置**到 APP（可拆分存储+混淆等）。
  - [ ] 修改 `ActivationManager.decodeActivationCode`：
    - 输入：用户粘贴的激活码（Base64 urlsafe）。
    - 步骤：
      1. `Base64.urlsafe_decode` 得到加密数据。
      2. 使用 Fernet 兼容逻辑解密，得到明文。
      3. 按 `deviceId:maxActivations:salt` 解析。
    - 解密失败或格式错误时，返回明确错误信息（例如“无效激活码”“激活码格式错误”）。

### 2.2 从临时 Base64 方案迁移到 Fernet 标准方案

- **目标**：用 Fernet 方案替换当前简化 Base64 文本方案。
- **任务**：
  - [ ] 修改 `ActivationManager.decodeActivationCode`，弃用当前 `Base64.decode(...split(":"))` 简化逻辑。
  - [ ] 确认新逻辑只接受 Fernet 格式，避免未来混淆。
  - [ ] 如需兼容历史测试激活码，可增加兼容分支（先尝试 Fernet，失败再尝试旧格式），后续版本可移除兼容逻辑。

---

## 阶段3：高级功能锁定（严格按 `is_activated()` 控制）

### 3.1 梳理所有“高级功能”入口

- **目标**：明确所有需要付费解锁的功能点。
- **任务**：
  - [ ] 列出所有需锁定的功能（按《加密.md》与实际需求）：
    - 批量短信处理（例如批量删除、批量标记等）。
    - 其他应视为“买断功能”的特性。
  - [ ] 在文档中标注每个功能对应的 Kotlin 文件与函数/入口。

### 3.2 在高级功能入口增加 `isActivated()` 检查

- **目标**：实现与《加密.md》中 Python 示例 `if not is_activated(): raise Exception("请激活买断版")` 等价的行为。
- **任务**：
  - [ ] 在每个高级功能的点击事件或入口处增加：
    - 若 `!ActivationManager.isActivated(context)`：
      - 禁止执行实际逻辑。
      - 弹出激活提示（可复用 `ActivationDialog` 或单独轻量对话框，含“去激活”按钮）。
  - [ ] 已激活用户保持当前体验，无额外打扰。

---

## 阶段4：到期弹窗与用户体验完善

### 4.1 完善到期弹窗与激活集成

- **目标**：与《加密.md》描述的到期行为对齐。
- **任务**：
  - [ ] 核对 `MainActivity` 中到期判断逻辑，确保：
    - 仅当日期大于 `2026-01-01` 且 `!isActivated()` 时才弹出激活相关 UI。
  - [ ] 调整到期文案为：
    - 提示“购买激活码继续使用高级功能”。
    - 说明未激活仍可使用基础功能，但高级功能受限。
    - 引导用户查看设备 ID 并说明购买方式（12 元/码，一机一码，默认 3 次激活）。
  - [ ] 确保多次打开 APP 时行为一致：
    - 已激活：不再弹出到期/激活提示。
    - 未激活且未到期：不弹。

### 4.2 设置页文案与说明对齐

- **目标**：设置页面说明与《加密.md》一致。
- **任务**：
  - [ ] 检查“买断激活状态”卡片文案，确保包含：
    - “本 APP 买断制：12 元/码，一码一机，限 3 次激活。”
    - 激活过程完全离线、不上传数据的说明。
    - 购买及联系邮箱（如：`709662224@qq.com` 或你最终确定的地址）。
  - [ ] 在软件声明中补充：
    - 一码一机规则。
    - 换设备/补发激活码/退款等政策的简要说明。

---

## 阶段5：安全与混淆

### 5.1 代码和数据安全强化

- **目标**：降低普通用户通过逆向/篡改绕过激活的可能性。
- **任务**：
  - [ ] 在 `android/app/build.gradle` 的 release 配置中开启 `minifyEnabled true`。
  - [ ] 在 `proguard-rules.pro` 中：
    - [ ] 为激活相关类（例如 `ActivationManager`、`DeviceIdManager`）配置合适的混淆规则：
      - 既不破坏逻辑运行，又避免类名/方法名过于直白。
    - [ ] 若使用 Gson 反序列化，确保相关数据类保留必要字段（`-keepclassmembers`）。
  - [ ] 对存储激活数据的 SharedPreferences：
    - [ ] 使用不明显的文件名和 key 名，降低直观可读性。
    - [ ] 可选：改用 `EncryptedSharedPreferences` 存储激活信息。

---

## 阶段6：测试与验证（对齐《加密.md》的测试指南）

### 6.1 单元测试

- **目标**：覆盖激活核心逻辑的主要分支。
- **任务**：
  - [ ] 为 `ActivationManager` 编写单元测试（Kotlin/JUnit）：
    - 正常激活码 → 解密成功、设备匹配、激活次数递减。
    - 设备 ID 不匹配。
    - 激活次数为 0 时应拒绝激活。
    - 激活码格式错误 / 解密失败。
  - [ ] （可选）模拟不同 ANDROID_ID 场景，验证“一机一码”的有效性。

### 6.2 端到端测试

- **目标**：验证“发码 → 用户输入 → 解锁高级功能/锁定高级功能”的完整流程。
- **任务**：
  - [ ] 在真实设备或多台模拟器上测试：
    - 首次安装 APP → 到期后弹窗 → 输入激活码 → 高级功能解锁。
    - 卸载重装 → 再次输入相同激活码 → 剩余次数递减。
    - 将激活数据文件复制到另一台设备 → 校验因设备 ID 不匹配而失效。
  - [ ] 验证边界情况：
    - 无效激活码。
    - 手工篡改本地激活数据（校验和失效时的行为）。
    - 时间跨越到期日之前/之后的不同表现。

---

## 阶段7：文档与交付

### 7.1 用户与开发者文档更新

- **目标**：让终端用户与开发者都能清楚理解买断机制与操作流程。
- **任务**：
  - [ ] 更新 `README.md`，添加买断功能的简要说明。
  - [ ] 创建或更新 `docs/ACTIVATION_USER_GUIDE.md`：
    - 如何在 APP 中查看设备 ID。
    - 如何购买激活码（12 元/码，一机一码，默认 3 次激活）。
    - 如何在 APP 内输入激活码完成激活。
    - 常见问题（换设备、次数用尽、忘记激活码等）。
  - [ ] 创建或更新 `docs/ACTIVATION_DEVELOPER_GUIDE.md`：
    - 如何配置和使用 `generate_activation_code.py`。
    - 如何管理和备份 Fernet 密钥。
    - 如何处理用户换设备/补发码/退款等场景。

---

## 开发顺序建议

- **优先完成**：
  1. 阶段1（密钥与 Python 生成脚本）
  2. 阶段2（Android Fernet 解密对齐）
  3. 阶段3（高级功能锁定）
- **随后推进**：
  4. 阶段4（到期弹窗与设置页文案完善）
  5. 阶段5（安全与混淆）
  6. 阶段6（测试与验证）
  7. 阶段7（文档与交付）

按以上阶段依次推进，可以逐步从“当前部分可用的简化方案”，演进到**完全符合《加密.md》规范的买断激活体系**。 


