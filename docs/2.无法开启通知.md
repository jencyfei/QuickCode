# 📘《通知开关灰色问题修复 — 通知渠道初始化需求文档》

## 一、问题背景

在小米 14 / 小米机型（含 HyperOS）上，App 的通知设置中出现 “**允许通知**” 按钮灰色不可开启的情况。

经分析，根本原因是：

> **App 启动后未正确向系统注册任何 NotificationChannel**
> → 系统判定为 “无通知功能应用”
> → 主通知开关被锁定（灰色）

因此通知渠道必须在 App 初始化流程中 **确保被创建并注册**, 否则用户无法开启通知。

---

## 二、修复目标（Must Have）

1. **App 启动时自动创建并注册通知渠道**（只要运行一次即可）
2. 创建渠道需要在 **不依赖用户操作** 的情况下执行
3. 渠道创建成功后，进入系统通知设置 → 主开关恢复可用（不再是灰色）
4. 渠道名称与 ID 固定，不随版本变更

---

## 三、需要新增或修复的内容

### ① 在 Application.onCreate() 中创建通知渠道（强制要求）

确保在 App 启动时就执行以下逻辑：

* 创建并注册至少 **一个 NotificationChannel**
* importance 必须为 `IMPORTANCE_HIGH`
* ID 必须固定：`express_channel`
* 名称固定：`快递提醒`

---

## 四、开发需实现的功能逻辑

### **在 Application 层新增通知渠道初始化模块**

示例逻辑（Kotlin 或 Java 均可，自行选择）：

```kotlin
class MyApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        initNotificationChannel()
    }

    private fun initNotificationChannel() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val channel = NotificationChannel(
                "express_channel",      // 固定 ID
                "快递提醒",               // 固定渠道名称
                NotificationManager.IMPORTANCE_HIGH
            ).apply {
                description = "用于快递取件码提醒的通知渠道"
            }

            val manager = getSystemService(NotificationManager::class.java)
            manager?.createNotificationChannel(channel)
        }
    }
}
```

---

## 五、注意事项（必须遵守）

1. **渠道必须在 Application 初始化执行，不允许放在 Activity/Receiver 中创建**

   * 小米系统只有在 App 运行时注册成功，才会解锁通知主开关
2. 不得重复创建，但可多次调用 `createNotificationChannel`（系统会自动去重）
3. 渠道 ID 一旦创建不得修改（否则系统会创建多个渠道）
4. importance 必须 ≥ HIGH

   * 否则小米仍会认为没有横幅能力
5. 所有通知后续都必须使用该渠道发送

---

## 六、验收标准（测试方法）

开发完成后测试步骤：

1. 卸载 App
2. 重新安装 → 启动一次 App
3. 前往系统：
   设置 → 通知与控制中心 → 通知管理 → 你的 App

**验收点：**

* “允许通知”主开关 **可正常点击**（不再灰色）
* “快递提醒”渠道出现在列表中
* 如触发一次测试通知，能正常显示横幅

---

## 七、可选（但推荐）优化项

* 添加一个“测试通知”按钮（用于本地验证渠道有效性）
* 在 App 内检测渠道是否已创建，如果不存在，则自动重新创建

