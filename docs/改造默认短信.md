# 📘 《默认短信应用最小化改造需求文档》

## 1. 背景说明

当前 App 通过 `content://sms` 读取手机短信，但在 **小米 14（Android 14/HyperOS）** 上：

* 由于 App 不是默认短信应用
* 系统只放行“白名单短信”（如 04526 开头的通道短信）
* 其他普通短信（快递/银行/营销/广告）均被屏蔽

为保证应用能识别所有取件码短信，需要实现成为 **系统默认短信应用** 的最小能力。

---

# 2. 改造目标（MVP）

本次改造目标：

> **实现成为默认短信应用所必须的最小系统能力，但不做完整短信功能 UI。**

最终实现：

* App 能读取 **所有短信**（收件箱 / 发件箱 / 归档）
* App 能实时接收到短信内容（BroadcastReceiver）
* App 能自行解析取件码 → 内部展示 → 分类打标签
* 用户体验保持轻量，不需要像短信应用一样聊天 UI

---

# 3. 改造范围（最小闭环）

## 3.1 必须实现的 Android 系统要求

| 能力                                   | 目的                  | 是否需要 UI            |
| ------------------------------------ | ------------------- | ------------------ |
| 接收短信：`SMS_DELIVER` BroadcastReceiver | 让系统认为本 App 能处理收到的短信 | 不需要界面              |
| 发送短信能力（Stub）                         | 满足系统对短信应用的要求        | 无界面，仅需 Service 或封装 |
| 写入短信能力（Stub）                         | 系统要求具备写入/删除能力       | 不需要实际操作            |
| 最少一个可启动的短信主页面 Activity               | 用户点击图标能打开           | 可为极简空页面            |
| 请求切换默认短信应用的流程                        | 让用户授权               | 必须有                |

---

# 4. 功能需求（可直接给开发）

## 4.1 短信接收模块（必做）

系统要求默认短信应用必须接收短信。
App 需新增：

### 🔹 SmsReceiver（接收短信）

* 监听 `android.provider.Telephony.SMS_DELIVER`
* 拿到短信内容后：

  * 解析发件人
  * 解析短信正文
  * 执行取件码识别逻辑
  * 将数据写入 App 自己的数据库

**不需要展示短信对话。**

---

## 4.2 短信读取模块（必做）

切换为默认短信应用后，App 可以完整访问 `content://sms/*`。

需求：

* 读取短信类型：inbox / sent / draft
* 首次启动时做一次全量同步
* 后续增量同步通过 SmsReceiver 完成

---

## 4.3 发送短信能力（Stub）

为了让 Android 正式把 App 识别为短信应用，必须具备发送能力。

需求：

* 新增 SmsSendService（内部使用 `SmsManager`）
* 对外不提供发送 UI
* 不对用户暴露短信发送入口

**目的只是满足 Android 系统检查，不需要实际发送功能。**

---

## 4.4 写短信能力（Stub）

Android 要求默认短信 App 具备对短信数据库进行写操作的能力。

需求：

* 提供写入短信/删除短信的最简实现
* 不在 UI 中公开“删除短信”“编辑短信”入口

**仅为满足系统检查。**

---

## 4.5 默认短信应用切换流程

### 功能点

* 引导用户设置 App 为默认短信应用
* 调用系统 Intent：

```kotlin
val intent = Intent(Telephony.Sms.Intents.ACTION_CHANGE_DEFAULT)
intent.putExtra(
    Telephony.Sms.Intents.EXTRA_PACKAGE_NAME,
    context.packageName
)
startActivity(intent)
```

### 引导文案（给用户看的）

* 不强调“读取隐私短信”
* 重点强调“用于识别快递取件码”
* 给出小米手机的正确操作说明

文案建议（可直接使用）：

> 为了让【XX App】自动识别您的快递取件码，需要您将本应用设为系统短信服务。
> 不会影响您继续使用微信 / QQ 收发消息，也不会修改您的短信内容。

---

## 4.6 基础 UI 页面（最简实现）

系统要求必须具备一个可打开的主界面（短信 App 的入口），但不要求展示对话列表。

需求：

* 一个极简 Activity：

  * 标题：“短信服务已启用”
  * 展示 App 的分类标签页（快递 / 银行 / 营销等）
* 此 Activity 不承担聊天功能

---

# 5. 非改造范围（明确不做）

为了保持产品轻量化，本次不实现：

❌ 聊天界面
❌ 短信会话列表
❌ 短信编辑页面
❌ 群发短信
❌ 消息气泡 UI
❌ 长按删除/复制短信
❌ 彩信（MMS）支持

---

# 6. 技术实现要求（工程落地）

## 6.1 Manifest 必填项

```xml
<uses-permission android:name="android.permission.READ_SMS"/>
<uses-permission android:name="android.permission.RECEIVE_SMS"/>
<uses-permission android:name="android.permission/SEND_SMS"/>
<uses-permission android:name="android.permission/WRITE_SMS"/>
```

组件：

* `SmsReceiver`（SMS_DELIVER）
* `SmsSendService`
* `SmsHomeActivity`（空 UI）
* 主 Activity 添加 LAUNCHER + DEFAULT category

---

# 7. 兼容性要求

必须在以下机型/系统通过测试：

| 品牌        | 系统版本                 | 重点         |
| --------- | -------------------- | ---------- |
| 小米 14     | HyperOS / Android 14 | 默认短信权限完全开放 |
| 小米 12/13  | MIUI 14              | 同样受限制      |
| 华为        | HarmonyOS 3/4        | 默认应用检查严格   |
| OPPO/Vivo | Android 13-14        | 默认应用限制打开   |

---

# 8. 风险与缓解

| 风险                  | 描述      | 缓解措施                      |
| ------------------- | ------- | ------------------------- |
| 用户不愿将 App 设置为默认短信应用 | 最常见问题   | 通过“短信不会被修改”“不会影响微信使用”降低顾虑 |
| 误操作导致短信设置冲突         | 用户切换后反悔 | 提供一键“恢复系统短信应用”入口          |
| Android 后续版本加强限制    | 系统层行为变化 | 保留通知栏 OCR 备选方案            |

---

# 9. 未来可扩展（非本次范围）

如果你后续想更丰富功能，可以加：

* 短信防骚扰
* 智能分类
* AI 取件码识别增强
* 云同步

---

# 📌 10. 本次改造交付物（明确输出）

1. `SmsReceiver` 能收到所有短信
2. 默认短信应用切换流程 UI
3. 支持读取 + 解析所有短信
4. 最小可运行的短信主页面
5. 识别取件码并分类
6. 小米 14 实机可读到所有快递短信
7. 发短信/写短信 Stub 功能满足系统检查

---
