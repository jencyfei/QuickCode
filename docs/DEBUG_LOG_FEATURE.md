# 应用内调试日志功能说明

## 功能概述

为了帮助排查短信识别问题（特别是10684发件人的菜鸟驿站短信和9-5-5038取件码），我们在应用中添加了一个**应用内调试日志窗口**功能。

## 新增功能

### 1. 内存日志管理器 (`InMemoryLogger.kt`)

- 在内存中保存最多2000条日志
- 支持实时监听日志更新
- 支持按标签、级别过滤日志
- 支持关键词搜索
- 支持导出日志为文本

### 2. 调试日志屏幕 (`DebugLogScreen.kt`)

- 实时显示应用运行日志
- 支持按标签过滤（SmsReader、ExpressExtractor、ExpressCompanyDetector）
- 支持关键词搜索（如：10684、9-5-5038）
- 支持自动滚动到底部
- 支持复制日志到剪贴板
- 支持清空日志

### 3. 增强的日志记录

在以下位置添加了详细日志：

#### SmsReader.kt
- ✅ 检测到10684发件人时输出详细日志
- ✅ 检测到包含"9-5-5038"的短信时输出警告日志
- ✅ 检测到包含"菜鸟驿站"的短信时输出日志

#### ExpressExtractor.kt
- ✅ 提取取件码时输出详细日志
- ✅ 检测到包含"9-5-5038"的短信时输出警告日志
- ✅ 菜鸟驿站取件码提取过程的详细日志

#### ExpressCompanyDetector.kt
- ✅ 检测快递公司时的详细日志
- ✅ 10684发件人识别过程的日志
- ✅ 识别失败时的警告日志

## 使用方法

### 打开调试日志窗口

1. 打开应用
2. 进入"设置"页面（底部导航栏）
3. 在设置页面找到"调试日志"卡片
4. 点击进入调试日志窗口

### 查看特定日志

#### 方法1：使用搜索框

1. 在调试日志窗口顶部的搜索框中输入关键词
2. 例如：
   - `10684` - 查找所有10684发件人的相关日志
   - `9-5-5038` - 查找所有包含此取件码的日志
   - `菜鸟驿站` - 查找所有菜鸟驿站相关的日志

#### 方法2：使用过滤标签

点击顶部的过滤标签：
- `SmsReader` - 只显示短信读取相关日志
- `ExpressExtractor` - 只显示快递信息提取相关日志
- `Detector` - 只显示快递公司识别相关日志

#### 方法3：查看统计信息

顶部显示日志统计信息：
- 总数：所有日志条数
- ERROR：错误日志数量
- WARN：警告日志数量
- INFO：信息日志数量
- DEBUG：调试日志数量

### 复制日志

1. 点击右上角的"复制"图标
2. 日志将被复制到剪贴板
3. 可以粘贴到其他应用中查看或保存

### 清空日志

1. 点击右上角的"删除"图标
2. 确认清空所有日志

## 关键日志说明

### 10684发件人识别日志

当应用读取到10684开头的短信时，会输出：

```
🔍🔍🔍 发现10684发件人短信！[第X行] _ID=xxx, 发件人=10684xxx, 内容=..., 时间=..., 类型=...
✅✅✅ 10684发件人短信包含'菜鸟驿站'！完整内容: ...
```

### 9-5-5038取件码识别日志

当应用检测到包含9-5-5038取件码的短信时，会输出：

```
🎯🎯🎯 找到目标取件码9-5-5038！发件人=..., 完整内容: ...
✅✅✅ 成功提取取件码: 9-5-5038
```

### 快递公司识别日志

```
🔍 开始检测快递公司: 发件人=10684xxx, 内容=...
  ✅ 发件人匹配: 类型=cainiao, 规则=CAINIAO, 95188, 10684
✅ 识别为快递: 菜鸟驿站 (类型=cainiao)
```

## 排查问题步骤

### 问题：10684发件人的短信未被识别

1. 打开调试日志窗口
2. 在搜索框输入 `10684`
3. 查看是否出现以下日志：
   - ✅ `🔍🔍🔍 发现10684发件人短信！` - 说明短信已被读取
   - ✅ `✅ 识别为快递: 菜鸟驿站` - 说明快递公司识别成功
   - ✅ `✅✅✅ 成功提取取件码: ...` - 说明取件码提取成功
4. 如果缺少某些日志，说明问题出现在对应环节

### 问题：9-5-5038取件码未被识别

1. 打开调试日志窗口
2. 在搜索框输入 `9-5-5038`
3. 查看日志流程：
   - 短信读取 → 快递公司识别 → 取件码提取 → 快递信息生成
4. 找到断点，定位问题

## 注意事项

1. **日志数量限制**：最多保存2000条日志，超出后会自动删除最早的日志
2. **性能影响**：日志记录对性能影响很小，但建议在排查完问题后关闭自动滚动
3. **隐私安全**：日志可能包含敏感信息，复制日志时请注意保护隐私

## 技术实现

### 日志流向

```
AppLogger (统一日志接口)
    ├── Logcat (系统日志)
    ├── LogFileWriter (文件日志)
    └── InMemoryLogger (内存日志) ← 新增
        └── DebugLogScreen (UI显示) ← 新增
```

### 关键类

- `InMemoryLogger` - 内存日志管理器（单例）
- `DebugLogScreen` - 调试日志UI屏幕
- `AppLogger` - 统一的日志接口（已增强）

## 未来改进

- [ ] 支持日志级别过滤（只显示ERROR/WARN）
- [ ] 支持时间范围过滤
- [ ] 支持日志导出为文件
- [ ] 支持日志自动保存到文件
- [ ] 支持日志关键字高亮

## 更新日志

### v1.3.1 (当前版本)

- ✅ 添加应用内调试日志窗口
- ✅ 增强短信读取日志（10684发件人）
- ✅ 增强取件码提取日志（9-5-5038）
- ✅ 增强快递公司识别日志
- ✅ 添加内存日志管理器
- ✅ 添加调试日志UI组件

---

**使用提示**：如果遇到短信识别问题，首先打开调试日志窗口，搜索相关关键词（如10684、9-5-5038），查看完整的日志流程，可以帮助快速定位问题所在。

