# æ¿€æ´»ç ç”Ÿæˆç³»ç»Ÿè¯´æ˜æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å½“å‰é¡¹ç›®ä¸­ä¸æ¿€æ´»ç ç”Ÿæˆç›¸å…³çš„è„šæœ¬å’Œä»£ç ï¼Œä»¥åŠå¦‚ä½•åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„æ¿€æ´»ç ç”Ÿæˆåº”ç”¨ã€‚

---

## ğŸ” å½“å‰é¡¹ç›®ä¸­çš„æ¿€æ´»ç ç›¸å…³æ–‡ä»¶

### 1. Python æ¿€æ´»ç ç”Ÿæˆè„šæœ¬ï¼ˆå¼€å‘è€…ç«¯ï¼‰

**æ–‡ä»¶è·¯å¾„**: `tools/generate_activation_code.py`

**åŠŸèƒ½**:
- æ ¹æ®è®¾å¤‡IDç”Ÿæˆæ¿€æ´»ç 
- æ”¯æŒæ‰¹é‡ç”Ÿæˆ
- æ”¯æŒCSVå¯¼å‡º
- ä½¿ç”¨ Fernet åŠ å¯†ç®—æ³•

**ä¾èµ–**:
```bash
pip install cryptography
```

**ä½¿ç”¨æ–¹æ³•**:
```bash
# ç”Ÿæˆå•ä¸ªæ¿€æ´»ç 
python tools/generate_activation_code.py --device-id "ç”¨æˆ·çš„è®¾å¤‡ID" --max-activations 3

# æ‰¹é‡ç”Ÿæˆå¤šä¸ªæ¿€æ´»ç 
python tools/generate_activation_code.py --device-id "ç”¨æˆ·çš„è®¾å¤‡ID" --max-activations 3 --count 5

# å¯¼å‡ºåˆ°CSVæ–‡ä»¶
python tools/generate_activation_code.py --device-id "ç”¨æˆ·çš„è®¾å¤‡ID" --max-activations 3 --count 10 --output-csv codes.csv
```

**å¯†é’¥æ–‡ä»¶**:
- å¯†é’¥æ–‡ä»¶è·¯å¾„: `tools/activation.key`
- ç”Ÿæˆå¯†é’¥å‘½ä»¤:
  ```bash
  python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
  ```
- å°†ç”Ÿæˆçš„å¯†é’¥ä¿å­˜åˆ° `tools/activation.key` æ–‡ä»¶ä¸­

---

### 2. Android ç«¯æ¿€æ´»éªŒè¯ä»£ç 

#### 2.1 è®¾å¤‡IDç”Ÿæˆå™¨

**æ–‡ä»¶è·¯å¾„**: `android/app/src/main/java/com/sms/tagger/util/DeviceIdManager.kt`

**åŠŸèƒ½**:
- åŸºäº `ANDROID_ID` ç”Ÿæˆå”¯ä¸€è®¾å¤‡ID
- ä½¿ç”¨ SHA-256 å“ˆå¸Œç¡®ä¿å”¯ä¸€æ€§å’Œéšç§æ€§
- æä¾›çŸ­ç æ˜¾ç¤ºæ ¼å¼ï¼ˆç”¨äºUIå±•ç¤ºï¼‰

**å…³é”®æ–¹æ³•**:
```kotlin
fun getDeviceId(context: Context): String  // è·å–å®Œæ•´è®¾å¤‡IDï¼ˆ64ä½åå…­è¿›åˆ¶ï¼‰
fun getDeviceIdShortCode(context: Context): String  // è·å–çŸ­ç ï¼ˆXXXX-XXXX-XXXXæ ¼å¼ï¼‰
```

---

#### 2.2 æ¿€æ´»ç®¡ç†å™¨

**æ–‡ä»¶è·¯å¾„**: `android/app/src/main/java/com/sms/tagger/util/ActivationManager.kt`

**åŠŸèƒ½**:
- éªŒè¯æ¿€æ´»ç 
- ç®¡ç†æ¿€æ´»çŠ¶æ€
- è·Ÿè¸ªå‰©ä½™æ¿€æ´»æ¬¡æ•°
- æœ¬åœ°å­˜å‚¨æ¿€æ´»ä¿¡æ¯

**å…³é”®æ–¹æ³•**:
```kotlin
fun getDeviceIdForUser(context: Context): String  // è·å–è®¾å¤‡IDä¾›ç”¨æˆ·å¤åˆ¶
fun isActivated(context: Context): Boolean  // æ£€æŸ¥æ˜¯å¦å·²æ¿€æ´»
fun validateActivationCode(context: Context, rawCode: String): Result<String>  // éªŒè¯æ¿€æ´»ç 
fun getRemainingActivations(context: Context): Int  // è·å–å‰©ä½™æ¿€æ´»æ¬¡æ•°
```

**Fernetå¯†é’¥**:
- ç¡¬ç¼–ç åœ¨ `ActivationManager.kt` ä¸­çš„ `FERNET_KEY`
- å¿…é¡»ä¸ Python è„šæœ¬ä½¿ç”¨çš„å¯†é’¥ä¸€è‡´

---

#### 2.3 Fernet è§£å¯†å™¨

**æ–‡ä»¶è·¯å¾„**: `android/app/src/main/java/com/sms/tagger/util/FernetDecryptor.kt`

**åŠŸèƒ½**:
- å®ç° Fernet ç®—æ³•çš„è§£å¯†åŠŸèƒ½
- å…¼å®¹ Python `cryptography.fernet` åº“ç”Ÿæˆçš„åŠ å¯†æ•°æ®
- éªŒè¯ HMAC ç­¾åç¡®ä¿æ•°æ®å®Œæ•´æ€§

---

### 3. æ¿€æ´»ç æ ¼å¼è¯´æ˜

**æ˜æ–‡æ ¼å¼**:
```
{device_id}:{max_activations}:{salt}
```

**ç¤ºä¾‹**:
```
a1b2c3d4e5f6...:3:1a2b3c4d5e6f7g8h
```

**åŠ å¯†æµç¨‹**:
1. ä½¿ç”¨ Fernet å¯†é’¥åŠ å¯†æ˜æ–‡
2. ä½¿ç”¨ Base64 URL-safe ç¼–ç åŠ å¯†åçš„æ•°æ®

**å®Œæ•´æ ¼å¼**:
```
base64.urlsafe_b64encode(fernet_encrypt("{device_id}:{max_activations}:{salt}"))
```

---

## ğŸš€ åˆ›å»ºæ–°çš„æ¿€æ´»ç ç”Ÿæˆ App é¡¹ç›®

### é¡¹ç›®ç»“æ„å»ºè®®

```
activation-code-generator/
â”œâ”€â”€ backend/                    # åç«¯æœåŠ¡ï¼ˆå¯é€‰ï¼‰
â”‚   â”œâ”€â”€ api/                    # APIæ¥å£
â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”œâ”€â”€ frontend/                   # å‰ç«¯ç•Œé¢
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/         # UIç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ pages/              # é¡µé¢
â”‚   â”‚   â””â”€â”€ utils/              # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ tools/                      # å‘½ä»¤è¡Œå·¥å…·
â”‚   â”œâ”€â”€ generate_activation_code.py  # æ¿€æ´»ç ç”Ÿæˆè„šæœ¬
â”‚   â””â”€â”€ activation.key          # å¯†é’¥æ–‡ä»¶ï¼ˆä¸æäº¤åˆ°Gitï¼‰
â”œâ”€â”€ docs/                       # æ–‡æ¡£
â”‚   â”œâ”€â”€ API.md                  # APIæ–‡æ¡£
â”‚   â””â”€â”€ æ¿€æ´»ç ç”Ÿæˆç³»ç»Ÿè¯´æ˜.md
â”œâ”€â”€ requirements.txt            # Pythonä¾èµ–
â”œâ”€â”€ README.md
â””â”€â”€ .gitignore
```

---

### å®ç°æ–¹æ¡ˆé€‰æ‹©

#### æ–¹æ¡ˆ1: Webåº”ç”¨ï¼ˆæ¨èï¼‰

**æŠ€æœ¯æ ˆ**:
- **å‰ç«¯**: React / Vue.js + TypeScript
- **åç«¯**: Python Flask / FastAPI
- **åŠ å¯†åº“**: `cryptography` (Fernet)

**ä¼˜ç‚¹**:
- è·¨å¹³å°è®¿é—®
- æ˜“äºéƒ¨ç½²å’Œç»´æŠ¤
- å¯ä»¥é›†æˆç”¨æˆ·ç®¡ç†ã€è®¢å•ç®¡ç†ç­‰

**æ ¸å¿ƒåŠŸèƒ½**:
1. è®¾å¤‡IDè¾“å…¥ç•Œé¢
2. æ¿€æ´»ç ç”Ÿæˆï¼ˆè°ƒç”¨åç«¯APIï¼‰
3. æ¿€æ´»ç å±•ç¤ºå’Œå¯¼å‡ºï¼ˆCSV/Excelï¼‰
4. æ¿€æ´»ç å†å²è®°å½•
5. æ‰¹é‡ç”ŸæˆåŠŸèƒ½

---

#### æ–¹æ¡ˆ2: æ¡Œé¢åº”ç”¨

**æŠ€æœ¯æ ˆ**:
- **æ¡†æ¶**: Electron / PyQt / Tkinter
- **åŠ å¯†åº“**: `cryptography` (Fernet)

**ä¼˜ç‚¹**:
- ç¦»çº¿ä½¿ç”¨
- æ•°æ®æ›´å®‰å…¨ï¼ˆå¯†é’¥ä¸é€šè¿‡ç½‘ç»œï¼‰

**æ ¸å¿ƒåŠŸèƒ½**:
1. æœ¬åœ°å¯†é’¥ç®¡ç†
2. è®¾å¤‡IDè¾“å…¥
3. æ¿€æ´»ç ç”Ÿæˆå’Œæ˜¾ç¤º
4. å¯¼å‡ºåŠŸèƒ½

---

#### æ–¹æ¡ˆ3: Android/iOS åŸç”Ÿåº”ç”¨

**æŠ€æœ¯æ ˆ**:
- **Android**: Kotlin + Jetpack Compose
- **iOS**: Swift + SwiftUI
- **åŠ å¯†**: Androidä½¿ç”¨ `FernetDecryptor.kt`ï¼ŒiOSéœ€è¦å®ç°Fernetè§£å¯†

**ä¼˜ç‚¹**:
- åŸç”Ÿä½“éªŒ
- é€‚åˆç§»åŠ¨ç«¯ä½¿ç”¨

---

### æ ¸å¿ƒä»£ç å‚è€ƒ

#### Python æ¿€æ´»ç ç”Ÿæˆå‡½æ•°

```python
from cryptography.fernet import Fernet
import base64
import secrets

def generate_activation_code(device_id: str, max_activations: int, key: bytes) -> str:
    """
    ç”Ÿæˆå•ä¸ªæ¿€æ´»ç 
    
    Args:
        device_id: è®¾å¤‡ID
        max_activations: æœ€å¤§æ¿€æ´»æ¬¡æ•°
        key: Fernetå¯†é’¥ï¼ˆbytesï¼‰
    
    Returns:
        æ¿€æ´»ç å­—ç¬¦ä¸²
    """
    salt = secrets.token_hex(8)
    payload = f"{device_id}:{max_activations}:{salt}"
    
    cipher = Fernet(key)
    encrypted = cipher.encrypt(payload.encode("utf-8"))
    
    code = base64.urlsafe_b64encode(encrypted).decode("utf-8")
    return code
```

---

#### FastAPI åç«¯ç¤ºä¾‹

```python
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from cryptography.fernet import Fernet
import base64
import secrets
from pathlib import Path

app = FastAPI()

# åŠ è½½å¯†é’¥ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä»ç¯å¢ƒå˜é‡æˆ–å®‰å…¨å­˜å‚¨è¯»å–ï¼‰
KEY_FILE = Path("tools/activation.key")
FERNET_KEY = KEY_FILE.read_text().strip().encode() if KEY_FILE.exists() else None

class ActivationRequest(BaseModel):
    device_id: str
    max_activations: int = 3
    count: int = 1

class ActivationResponse(BaseModel):
    codes: list[str]
    device_id: str
    max_activations: int

@app.post("/api/generate", response_model=ActivationResponse)
async def generate_activation_codes(request: ActivationRequest):
    """ç”Ÿæˆæ¿€æ´»ç """
    if not FERNET_KEY:
        raise HTTPException(status_code=500, detail="å¯†é’¥æœªé…ç½®")
    
    if not request.device_id or request.max_activations <= 0:
        raise HTTPException(status_code=400, detail="å‚æ•°é”™è¯¯")
    
    codes = []
    for _ in range(request.count):
        salt = secrets.token_hex(8)
        payload = f"{request.device_id}:{request.max_activations}:{salt}"
        
        cipher = Fernet(FERNET_KEY)
        encrypted = cipher.encrypt(payload.encode("utf-8"))
        code = base64.urlsafe_b64encode(encrypted).decode("utf-8")
        codes.append(code)
    
    return ActivationResponse(
        codes=codes,
        device_id=request.device_id,
        max_activations=request.max_activations
    )
```

---

#### React å‰ç«¯ç¤ºä¾‹

```tsx
import React, { useState } from 'react';
import axios from 'axios';

interface ActivationRequest {
  device_id: string;
  max_activations: number;
  count: number;
}

function ActivationCodeGenerator() {
  const [deviceId, setDeviceId] = useState('');
  const [maxActivations, setMaxActivations] = useState(3);
  const [count, setCount] = useState(1);
  const [codes, setCodes] = useState<string[]>([]);
  const [loading, setLoading] = useState(false);

  const handleGenerate = async () => {
    if (!deviceId.trim()) {
      alert('è¯·è¾“å…¥è®¾å¤‡ID');
      return;
    }

    setLoading(true);
    try {
      const response = await axios.post<{ codes: string[] }>('/api/generate', {
        device_id: deviceId,
        max_activations: maxActivations,
        count: count,
      });
      setCodes(response.data.codes);
    } catch (error) {
      alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    } finally {
      setLoading(false);
    }
  };

  const handleExportCSV = () => {
    const csvContent = codes.map(code => `${deviceId},${maxActivations},${code}`).join('\n');
    const blob = new Blob([`device_id,max_activations,code\n${csvContent}`], {
      type: 'text/csv;charset=utf-8;',
    });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `activation_codes_${Date.now()}.csv`;
    link.click();
  };

  return (
    <div className="container">
      <h1>æ¿€æ´»ç ç”Ÿæˆå™¨</h1>
      
      <div className="form-group">
        <label>è®¾å¤‡ID:</label>
        <input
          type="text"
          value={deviceId}
          onChange={(e) => setDeviceId(e.target.value)}
          placeholder="è¾“å…¥è®¾å¤‡ID"
        />
      </div>

      <div className="form-group">
        <label>æœ€å¤§æ¿€æ´»æ¬¡æ•°:</label>
        <input
          type="number"
          value={maxActivations}
          onChange={(e) => setMaxActivations(parseInt(e.target.value))}
          min="1"
        />
      </div>

      <div className="form-group">
        <label>ç”Ÿæˆæ•°é‡:</label>
        <input
          type="number"
          value={count}
          onChange={(e) => setCount(parseInt(e.target.value))}
          min="1"
        />
      </div>

      <button onClick={handleGenerate} disabled={loading}>
        {loading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆæ¿€æ´»ç '}
      </button>

      {codes.length > 0 && (
        <div className="results">
          <h2>ç”Ÿæˆçš„æ¿€æ´»ç :</h2>
          <div className="codes-list">
            {codes.map((code, index) => (
              <div key={index} className="code-item">
                <span>{code}</span>
                <button onClick={() => navigator.clipboard.writeText(code)}>å¤åˆ¶</button>
              </div>
            ))}
          </div>
          <button onClick={handleExportCSV}>å¯¼å‡ºCSV</button>
        </div>
      )}
    </div>
  );
}

export default ActivationCodeGenerator;
```

---

### å®‰å…¨å»ºè®®

1. **å¯†é’¥ç®¡ç†**:
   - å¯†é’¥æ–‡ä»¶ä¸è¦æäº¤åˆ° Git
   - ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡
   - å®šæœŸæ›´æ¢å¯†é’¥

2. **è®¿é—®æ§åˆ¶**:
   - æ·»åŠ ç”¨æˆ·è®¤è¯
   - è®°å½•æ¿€æ´»ç ç”Ÿæˆæ—¥å¿—
   - é™åˆ¶APIè®¿é—®é¢‘ç‡

3. **æ•°æ®å¤‡ä»½**:
   - å®šæœŸå¤‡ä»½ç”Ÿæˆçš„æ¿€æ´»ç è®°å½•
   - ä½¿ç”¨æ•°æ®åº“å­˜å‚¨æ¿€æ´»ç å†å²

---

### æ‰©å±•åŠŸèƒ½å»ºè®®

1. **ç”¨æˆ·ç®¡ç†**: ç®¡ç†å‘˜è´¦æˆ·ã€æƒé™æ§åˆ¶
2. **è®¢å•ç®¡ç†**: å…³è”è®¢å•å·å’Œæ¿€æ´»ç 
3. **ç»Ÿè®¡åŠŸèƒ½**: æ¿€æ´»ç ä½¿ç”¨æƒ…å†µç»Ÿè®¡
4. **é€šçŸ¥åŠŸèƒ½**: æ¿€æ´»ç ç”ŸæˆæˆåŠŸåå‘é€é‚®ä»¶/çŸ­ä¿¡
5. **æ‰¹é‡å¯¼å…¥**: æ”¯æŒä»Excelæ‰¹é‡å¯¼å…¥è®¾å¤‡ID
6. **æ¿€æ´»è®°å½•**: è®°å½•æ¿€æ´»ç çš„æ¿€æ´»å†å²

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `docs/åŠ å¯†.md` - åŠ å¯†ç®—æ³•è¯¦ç»†è¯´æ˜
- `docs/æµç¨‹.md` - æ¿€æ´»æµç¨‹è¯´æ˜
- `tools/generate_activation_code.py` - Pythonç”Ÿæˆè„šæœ¬æºç 

---

## ğŸ”— ç›¸å…³æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒè„šæœ¬
- âœ… `tools/generate_activation_code.py` - Pythonæ¿€æ´»ç ç”Ÿæˆè„šæœ¬

### Androidç«¯ä»£ç 
- âœ… `android/app/src/main/java/com/sms/tagger/util/DeviceIdManager.kt` - è®¾å¤‡IDç”Ÿæˆ
- âœ… `android/app/src/main/java/com/sms/tagger/util/ActivationManager.kt` - æ¿€æ´»ç®¡ç†
- âœ… `android/app/src/main/java/com/sms/tagger/util/FernetDecryptor.kt` - Fernetè§£å¯†

### æ–‡æ¡£
- âœ… `docs/åŠ å¯†.md` - åŠ å¯†åè®®æ–‡æ¡£
- âœ… `docs/æµç¨‹.md` - æ¿€æ´»æµç¨‹æ–‡æ¡£
- âœ… `docs/æ¿€æ´»ç ç”Ÿæˆç³»ç»Ÿè¯´æ˜.md` - æœ¬æ–‡æ¡£

---

## ğŸ“ æ€»ç»“

å½“å‰é¡¹ç›®å·²ç»åŒ…å«å®Œæ•´çš„æ¿€æ´»ç ç”Ÿæˆå’ŒéªŒè¯ç³»ç»Ÿï¼š

1. **å¼€å‘è€…ç«¯**: Pythonè„šæœ¬ç”Ÿæˆæ¿€æ´»ç 
2. **ç”¨æˆ·ç«¯**: Androidåº”ç”¨éªŒè¯æ¿€æ´»ç 
3. **åŠ å¯†åè®®**: ä½¿ç”¨Fernetç®—æ³•ç¡®ä¿å®‰å…¨æ€§

è¦åˆ›å»ºæ–°çš„æ¿€æ´»ç ç”Ÿæˆåº”ç”¨ï¼Œå¯ä»¥å‚è€ƒä¸Šè¿°ä»£ç å’Œç»“æ„ï¼Œé€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ ˆå®ç°ã€‚

