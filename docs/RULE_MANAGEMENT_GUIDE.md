# 规则管理指南

## 概述

系统提供了完整的规则管理功能，允许用户自定义和编辑短信内容提取规则。包括：
- **取件码提取规则**
- **地址提取规则**
- **发件人提取规则**

## 访问规则管理页面

在前端应用中，点击导航栏中的"⚙️ 规则配置"或访问：
```
http://localhost:3000/rule-config
```

## 规则类型

### 1. 取件码规则 (pickup_code)
用于从短信中提取快递取件码。

**内置规则优先级**（从高到低）：

| 优先级 | 规则名称 | 正则表达式 | 示例 |
|--------|---------|----------|------|
| 10 | 标准取件码格式 | `取件码[：:是为]?\s*([A-Z0-9-]{4,12})` | 取件码：ABC123 |
| 9 | 提货码格式 | `提货码[：:是为]?\s*([A-Z0-9-]{4,12})` | 提货码：XYZ789 |
| **8** | **凭X-X-XXXX格式（优先级高）** | **`凭\s*(\d+-\d+-\d+)`** | **凭2-4-2029** ✅ |
| 7 | 凭XX取件格式（其他格式） | `凭\s*([A-Z0-9-]{3,12})` | 凭ABC123 |
| 6 | 横杠分隔数字（X-X-XXXX） | `(\d+-\d+-\d+)` | 2-4-2029 |
| 5 | 纯数字取件码 | `(?:取件码\|提货码\|验证码)[：:是为]?\s*(\d{4,8})` | 验证码：123456 |

**关键改进**：
- ✅ 优先级8：新增"凭X-X-XXXX格式"规则，优先匹配"凭2-4-2029"这样的数字格式
- ✅ 这确保了像"凭6-5-5011"这样的取件码能被正确识别为完整的码，而不是被分割

### 2. 地址规则 (address)
用于从短信中提取收货地址。

**内置规则优先级**（从高到低）：

| 优先级 | 规则名称 | 示例 |
|--------|---------|------|
| 10 | 驿站/快递柜地址 | 菜鸟驿站、丰巢快递柜 |
| 9 | 路名+驿站 | 人民路菜鸟驿站 |
| 8 | 小区/大厦+位置 | 阳光小区北门 |
| 7 | 菜鸟驿站 | 菜鸟驿站相关地址 |
| 6 | 丰巢快递柜 | 丰巢相关地址 |

### 3. 发件人规则 (sender)
用于从短信中提取发件人信息。

**内置规则优先级**（从高到低）：

| 优先级 | 规则名称 | 正则表达式 | 示例 |
|--------|---------|----------|------|
| 10 | 【发件人】格式 | `【(.+?)】` | 【菜鸟驿站】 |
| 9 | [发件人]格式 | `\[(.+?)\]` | [菜鸟驿站] |

## 如何添加自定义规则

### 步骤1：打开规则配置页面
访问 `http://localhost:3000/rule-config`

### 步骤2：选择规则类型
点击对应的标签页（取件码、地址、发件人）

### 步骤3：点击"添加规则"按钮
填写以下信息：

- **规则名称**：描述性的规则名称（如"菜鸟驿站取件码"）
- **正则表达式**：用于匹配的正则表达式
- **提取组**：指定要提取的捕获组（通常为1）
- **优先级**：数字越大优先级越高（0-100）
- **描述**：规则的说明文字
- **启用**：是否启用此规则

### 步骤4：测试规则
在"测试规则"区域输入测试文本，点击"测试"按钮验证规则是否正确

### 步骤5：保存规则
点击"保存"按钮

## 如何编辑现有规则

1. 在规则列表中找到要编辑的规则
2. 点击"编辑"按钮
3. 修改规则内容
4. 点击"测试"验证修改
5. 点击"保存"

## 如何删除规则

1. 在规则列表中找到要删除的规则
2. 点击"删除"按钮
3. 确认删除

## 如何启用/禁用规则

在规则列表中，点击规则右侧的开关按钮即可启用或禁用该规则。

## 使用规则模板

系统提供了预设的规则模板，可以快速应用：

1. 点击"规则模板"按钮
2. 选择要应用的模板
3. 系统会自动创建一个新规则

## 正则表达式基础

### 常用元字符

| 元字符 | 说明 | 示例 |
|--------|------|------|
| `.` | 匹配任意字符（除换行符） | `a.c` 匹配 abc |
| `*` | 匹配前面的元素0次或多次 | `ab*c` 匹配 ac, abc, abbc |
| `+` | 匹配前面的元素1次或多次 | `ab+c` 匹配 abc, abbc |
| `?` | 匹配前面的元素0次或1次 | `ab?c` 匹配 ac, abc |
| `[]` | 字符类，匹配括号内的任意字符 | `[abc]` 匹配 a, b, c |
| `[^]` | 否定字符类 | `[^abc]` 匹配除a,b,c外的字符 |
| `()` | 捕获组 | `(ab)+` 匹配 ab, abab |
| `\|` | 或 | `a\|b` 匹配 a 或 b |
| `\d` | 数字 | `\d{4}` 匹配4位数字 |
| `\s` | 空白符 | `\s+` 匹配一个或多个空白 |
| `\w` | 单词字符（字母、数字、下划线） | `\w+` 匹配单词 |

### 常用量词

| 量词 | 说明 | 示例 |
|------|------|------|
| `{n}` | 恰好n次 | `a{3}` 匹配 aaa |
| `{n,}` | 至少n次 | `a{2,}` 匹配 aa, aaa, ... |
| `{n,m}` | n到m次 | `a{2,4}` 匹配 aa, aaa, aaaa |

## 规则优先级说明

- **优先级数字越大，规则越优先执行**
- 系统会按优先级从高到低依次尝试每个规则
- 一旦某个规则匹配成功，就返回结果，不再尝试后续规则
- 建议为更具体的规则设置更高的优先级

## 常见规则示例

### 取件码规则

#### 示例1：提取"凭XXXX"格式的取件码
```
规则名称：凭字后的取件码
正则表达式：凭\s*([A-Z0-9-]{3,12})
提取组：1
优先级：8
```

#### 示例2：提取"取件码：XXXX"格式
```
规则名称：标准取件码标签
正则表达式：取件码[：:是为]?\s*([A-Z0-9-]{4,12})
提取组：1
优先级：10
```

#### 示例3：提取"X-X-XXXX"格式的数字取件码
```
规则名称：横杠分隔数字取件码
正则表达式：(\d+-\d+-\d+)
提取组：1
优先级：6
```

### 地址规则

#### 示例1：提取驿站地址
```
规则名称：菜鸟驿站地址
正则表达式：([^\s，。！？]{2,20}?(?:驿站|快递柜|门卫)(?:[^\s，。！？]{0,10})?)
提取组：1
优先级：9
```

### 发件人规则

#### 示例1：提取【】中的发件人
```
规则名称：中文括号发件人
正则表达式：【(.+?)】
提取组：1
优先级：10
```

## 故障排除

### 问题1：规则不匹配
**解决方案**：
1. 使用测试功能验证正则表达式
2. 检查提取组编号是否正确
3. 确认规则已启用
4. 检查优先级是否过低

### 问题2：提取结果不正确
**解决方案**：
1. 调整正则表达式的模式
2. 修改提取组编号
3. 提高规则优先级
4. 禁用冲突的其他规则

### 问题3：规则冲突
**解决方案**：
1. 为更具体的规则设置更高优先级
2. 禁用不需要的规则
3. 使用更精确的正则表达式

## API 接口

### 获取规则列表
```
GET /extraction-rules?rule_type=pickup_code
```

### 创建规则
```
POST /extraction-rules
{
  "name": "规则名称",
  "rule_type": "pickup_code",
  "pattern": "正则表达式",
  "extract_group": 1,
  "priority": 8,
  "is_active": true,
  "description": "规则描述"
}
```

### 更新规则
```
PUT /extraction-rules/{rule_id}
{
  "name": "新规则名称",
  "pattern": "新正则表达式",
  ...
}
```

### 删除规则
```
DELETE /extraction-rules/{rule_id}
```

### 测试规则
```
POST /extraction-rules/test
{
  "pattern": "正则表达式",
  "extract_group": 1,
  "test_text": "测试文本"
}
```

## 最佳实践

1. **从通用到具体**：优先级从高到低应该是：标签格式 > 特定格式 > 通用格式

2. **使用描述性名称**：规则名称应该清楚地说明其用途

3. **充分测试**：在保存前使用测试功能验证规则

4. **避免过度匹配**：使用具体的正则表达式避免误匹配

5. **定期审查**：定期检查规则列表，删除不需要的规则

6. **版本管理**：在修改重要规则前，记录原始规则内容

## 相关文档

- [SMS Parser 文档](./SMS_PARSER.md)
- [快递取件码修复指南](./EXPRESS_DETAIL_GUIDE.md)
- [规则引擎实现](../backend/app/services/rule_engine.py)
